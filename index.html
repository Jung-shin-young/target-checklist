<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>대상 조치 체크리스트</title>
  <style>
    :root{ --border:#ddd; --muted:#666; --bg:#fff; --chip:#f6f6f6; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 12px; background: var(--bg); padding-bottom: 86px; }
    h2 { margin: 8px 0 6px; }
    .muted { color:var(--muted); font-size: 13px; line-height: 1.35; }
    .card { border: 1px solid var(--border); border-radius: 14px; padding: 12px; margin: 10px 0; background:#fff; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input[type="text"]{ padding:12px 12px; border:1px solid #ccc; border-radius:14px; min-width:0; flex:1; }
    input[type="file"]{ max-width: 100%; }
    textarea { padding:10px 12px; border:1px solid #ccc; border-radius:14px; width: 100%; min-height: 84px; }
    button { padding:12px 12px; border:1px solid #ccc; border-radius:14px; cursor:pointer; background:#fff; }
    button.primary { border-color:#111; }
    button.big { padding: 14px 14px; font-weight: 700; }
    button.on { border-color:#111; background:#111; color:#fff; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:5px 10px; border-radius:999px; border:1px solid var(--border); font-size: 12px; background: var(--chip); }
    .danger { border-color:#c00; color:#900; background:#fff; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }

    /* status chips */
    .s-done { border-color:#0a0; color:#070; }
    .s-work { border-color:#c90; color:#850; }
    .s-open { border-color:#999; color:#333; }
    .s-etc  { border-color:#06c; color:#036; }

    /* mobile cards */
    .list { display:flex; flex-direction: column; gap: 10px; }
    .itemCard{
      border: 1px solid #eee;
      border-radius: 14px;
      padding: 12px;
      background: #fff;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .itemTop{ display:flex; justify-content:space-between; align-items:flex-start; gap: 10px; }
    .itemVin{ font-size: 18px; font-weight: 800; }
    .itemMeta{ display:flex; gap: 8px; flex-wrap: wrap; align-items:center; }
    .itemNote .label{ font-weight:700; margin-bottom:4px; }
    .itemActions{ display:flex; gap: 8px; flex-wrap: wrap; }
    .itemActions button{ flex: 1; min-width: 110px; }

    /* bottom filter bar */
    .bottomBar{
      position: fixed; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,.96);
      border-top: 1px solid var(--border);
      padding: 10px 10px;
      z-index: 30;
    }
    .bottomBar .barRow{ display:flex; gap:8px; }
    .bottomBar button{ flex: 1; padding: 12px 10px; }

    /* modal */
    .modalBack { position: fixed; inset:0; background: rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding: 14px; z-index: 50; }
    .modal { background:#fff; border-radius:16px; max-width:560px; width:100%; padding:16px; border:1px solid var(--border); }
    .modalHead { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .modalHead b { font-size: 16px; }
  </style>
</head>
<body>
  <h2>대상 조치 체크리스트</h2>
  <div class="muted">
    실시간으로 동기화됩니다. (누가 변경하면 다른 사람 화면도 바로 반영)<br/>
    업로드 규칙: 파일 안의 값 중 <b>숫자만</b> 추출 → 뒤 4자리만 VIN으로 사용(중복 자동 무시).
  </div>

  <div class="card">
    <div class="row">
      <input id="file" type="file" accept=".csv,.xlsx,.xls" />
      <button class="primary" id="btnImport">업로드(추가)</button>
      <button class="primary" id="btnExport">엑셀 다운로드</button>
    </div>
    <div style="height:10px"></div>
    <div class="row">
      <input id="search" type="text" placeholder="VIN 검색 (숫자 1~4자리)" />
      <span class="pill" id="statTotal">총 0</span>
      <span class="pill s-done" id="statDone">완료 0</span>
      <span class="pill danger" id="statLeft">잔여 0</span>
      <span class="muted" id="rtState">Realtime: 연결중...</span>
    </div>
  </div>

  <div class="list" id="list"></div>

  <!-- Bottom filter bar -->
  <div class="bottomBar">
    <div class="barRow">
      <button id="fAll">전체</button>
      <button id="fOpen">미완료</button>
      <button id="fWork">작업 중</button>
      <button id="fDone">완료</button>
      <button id="fEtc">기타</button>
    </div>
  </div>

  <!-- memo modal -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHead">
        <div><b>기타 메모</b> <span class="muted mono" id="modalVin"></span></div>
        <button id="modalClose">닫기</button>
      </div>
      <div style="height:10px"></div>
      <textarea id="modalNote" placeholder="특이사항만 간단히 적어주세요"></textarea>
      <div style="height:10px"></div>
      <div class="row" style="justify-content:flex-end;">
        <button class="primary big" id="modalSave">저장</button>
      </div>
      <div class="muted" style="margin-top:8px;">
        저장하면 상태가 <b>기타</b>로 설정됩니다.
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ======= 너의 Supabase 값으로 바꾸기 =======
    const SUPABASE_URL = "https://gpdtgrbiyrgekjtgxpgf.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdwZHRncmJpeXJnZWtqdGd4cGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1ODI3ODAsImV4cCI6MjA4NTE1ODc4MH0.tLZb3obtmHgWMTiKf4xhbsiOqmg80o2MPibQhB5Ywco";
    // =========================================

    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let items = [];
    let filterMode = "all"; // all | 미완료 | 작업 중 | 완료 | 기타

    const elFile = document.getElementById("file");
    const elImport = document.getElementById("btnImport");
    const elExport = document.getElementById("btnExport");
    const elSearch = document.getElementById("search");
    const list = document.getElementById("list");

    const statTotal = document.getElementById("statTotal");
    const statDone = document.getElementById("statDone");
    const statLeft = document.getElementById("statLeft");
    const rtState = document.getElementById("rtState");

    // filters
    document.getElementById("fAll").onclick  = () => { filterMode="all"; render(); };
    document.getElementById("fOpen").onclick = () => { filterMode="미완료"; render(); };
    document.getElementById("fWork").onclick = () => { filterMode="작업 중"; render(); };
    document.getElementById("fDone").onclick = () => { filterMode="완료"; render(); };
    document.getElementById("fEtc").onclick  = () => { filterMode="기타"; render(); };

    elSearch.addEventListener("input", () => render());

    function setRealtimeStatus(text) { rtState.textContent = "Realtime: " + text; }

    async function loadAll() {
      const { data, error } = await sb.from("items").select("*").order("vin", { ascending: true });
      if (error) { alert("데이터 로드 실패: " + error.message); return; }
      items = data || [];
      render();
    }

    function subscribeRealtime() {
      const channel = sb.channel("items-realtime");
      channel
        .on("postgres_changes", { event: "*", schema: "public", table: "items" }, (payload) => {
          const e = payload.eventType;
          if (e === "INSERT" || e === "UPDATE") upsertLocal(payload.new);
          else if (e === "DELETE") removeLocal(payload.old?.vin);
          render();
        })
        .subscribe((status) => {
          if (status === "SUBSCRIBED") setRealtimeStatus("연결됨 ✅");
          else setRealtimeStatus(status);
        });

      setInterval(() => loadAll(), 30000);
    }

    function upsertLocal(row) {
      const idx = items.findIndex(x => x.vin === row.vin);
      if (idx >= 0) items[idx] = row;
      else items.push(row);
      items.sort((a,b)=>String(a.vin).localeCompare(String(b.vin)));
    }
    function removeLocal(vin) { items = items.filter(x => x.vin !== vin); }

    function statusPillClass(s) {
      if (s === "완료") return "s-done";
      if (s === "작업 중") return "s-work";
      if (s === "기타") return "s-etc";
      return "s-open";
    }

    function formatKST(iso) {
      if (!iso) return "-";
      return new Date(iso).toLocaleString("ko-KR", {
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit"
      });
    }

    // ===== 핵심: 버튼 토글 로직 =====
    // 작업중 버튼: 미완료 <-> 작업 중 (완료/기타일 때 누르면 작업 중으로 바꿈)
    async function toggleWork(vin) {
      const x = items.find(v => v.vin === vin);
      if (!x) return;
      const next = (x.status === "작업 중") ? "미완료" : "작업 중";
      await setStatus(vin, next);
    }

    // 완료 버튼: 미완료/작업 중/기타 -> 완료, 완료 -> 미완료
    async function toggleDone(vin) {
      const x = items.find(v => v.vin === vin);
      if (!x) return;
      const next = (x.status === "완료") ? "미완료" : "완료";
      await setStatus(vin, next);
    }

    async function setStatus(vin, status) {
      const patch = { status };
      if (status === "완료") patch.done_at = new Date().toISOString();
      else patch.done_at = null;

      const { error } = await sb.from("items").update(patch).eq("vin", vin);
      if (error) alert(error.message);
      // realtime로도 오지만, 체감 빠르게 즉시 싱크
      await loadAll();
    }

    // ===== memo modal: 기타일 때만 =====
    const modalBack = document.getElementById("modalBack");
    const modalVin = document.getElementById("modalVin");
    const modalNote = document.getElementById("modalNote");
    const modalClose = document.getElementById("modalClose");
    const modalSave = document.getElementById("modalSave");
    let currentVin = null;

    function openMemo(vin, existingNote) {
      currentVin = vin;
      modalVin.textContent = `(${vin})`;
      modalNote.value = existingNote || "";
      modalBack.style.display = "flex";
      modalNote.focus();
    }
    function closeMemo() { modalBack.style.display = "none"; currentVin = null; }
    modalClose.onclick = closeMemo;
    modalBack.addEventListener("click", (e) => { if (e.target === modalBack) closeMemo(); });

    modalSave.onclick = async () => {
      if (!currentVin) return;
      const note = (modalNote.value || "").trim();

      // note 저장 + 상태를 기타로 설정 (완료시각은 제거)
      const { error } = await sb.from("items")
        .update({ note, status: "기타", done_at: null })
        .eq("vin", currentVin);

      if (error) alert(error.message);
      closeMemo();
      await loadAll();
    };

    // upload
    elImport.addEventListener("click", async () => {
      const f = elFile.files?.[0];
      if (!f) { alert("업로드할 파일을 선택해줘"); return; }

      try {
        const vins = await parseVinsFromFile(f);
        if (!vins.length) { alert("숫자(VIN)를 찾지 못했어. 파일 내용을 확인해줘."); return; }

        const existing = new Set(items.map(x => String(x.vin)));
        const rows = vins
          .filter(v => !existing.has(String(v)))
          .map(v => ({ vin: String(v), status: "미완료", note: "", done_at: null }));

        if (!rows.length) { alert("추가할 신규 VIN이 없어(전부 이미 존재)"); return; }

        const { error } = await sb.from("items").insert(rows);
        if (error) { alert("업로드 실패: " + error.message); return; }

        await loadAll();
        alert(`업로드 완료: 신규 ${rows.length}개 추가`);
      } catch (e) {
        console.error(e);
        alert("파일 파싱 중 오류. CSV/XLSX 형식인지 확인해줘.");
      } finally {
        elFile.value = "";
      }
    });

    // export
    elExport.addEventListener("click", () => {
      const rows = items.map(x => ({
        VIN: x.vin,
        status: x.status,
        note: x.note || "",
        done_at: x.done_at ? formatKST(x.done_at) : "",
        updated_at: x.updated_at ? formatKST(x.updated_at) : ""
      }));
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "checklist");
      XLSX.writeFile(wb, "대상_조치_체크리스트.xlsx");
    });

    function render() {
      const q = (elSearch.value || "").trim().replace(/\D/g,"").slice(0,4);
      let view = items;

      if (filterMode !== "all") view = view.filter(x => x.status === filterMode);
      if (q) view = view.filter(x => String(x.vin).includes(q));

      const total = items.length;
      const done = items.filter(x=>x.status==="완료").length;
      const left = total - done;
      statTotal.textContent = `총 ${total}`;
      statDone.textContent = `완료 ${done}`;
      statLeft.textContent = `잔여 ${left}`;

      list.innerHTML = "";

      for (const x of view) {
        const card = document.createElement("div");
        card.className = "itemCard";

        const top = document.createElement("div");
        top.className = "itemTop";

        const leftBox = document.createElement("div");
        const vinEl = document.createElement("div");
        vinEl.className = "itemVin mono";
        vinEl.textContent = x.vin;

        const meta = document.createElement("div");
        meta.className = "itemMeta";

        const st = document.createElement("span");
        st.className = "pill " + statusPillClass(x.status);
        st.textContent = x.status;

        const time = document.createElement("span");
        time.className = "pill";
        time.textContent = (x.status === "완료") ? formatKST(x.done_at) : "완료 시각 -";

        meta.appendChild(st);
        meta.appendChild(time);

        leftBox.appendChild(vinEl);
        leftBox.appendChild(meta);

        top.appendChild(leftBox);

        const noteBox = document.createElement("div");
        noteBox.className = "itemNote";
        noteBox.innerHTML = `
          <div class="label">메모</div>
          <div class="muted">${escapeHtml((x.note && x.note.trim()) ? x.note : "-")}</div>
        `;

        const actions = document.createElement("div");
        actions.className = "itemActions";

        const btnWork = document.createElement("button");
        btnWork.className = "big " + (x.status === "작업 중" ? "on" : "");
        btnWork.textContent = "작업중";
        btnWork.onclick = () => toggleWork(x.vin);

        const btnDone = document.createElement("button");
        btnDone.className = "big " + (x.status === "완료" ? "on" : "");
        btnDone.textContent = "완료";
        btnDone.onclick = () => toggleDone(x.vin);

        const btnMemo = document.createElement("button");
        btnMemo.className = "big " + (x.status === "기타" ? "on" : "");
        btnMemo.textContent = "메모";
        btnMemo.onclick = () => openMemo(x.vin, x.note || "");

        actions.appendChild(btnWork);
        actions.appendChild(btnDone);
        actions.appendChild(btnMemo);

        card.appendChild(top);
        card.appendChild(noteBox);
        card.appendChild(actions);

        list.appendChild(card);
      }
    }

    // parsing: 숫자만, 뒤 4자리 사용
    async function parseVinsFromFile(file) {
      const name = file.name.toLowerCase();
      if (name.endsWith(".csv")) return parseVinsFromCSV(file);
      if (name.endsWith(".xlsx") || name.endsWith(".xls")) return parseVinsFromXLSX(file);
      return parseVinsFromCSV(file);
    }

    function extract4DigitCodes(values) {
      const out = [];
      for (const v of values) {
        if (v === null || v === undefined) continue;
        const s = String(v).trim();
        if (!s) continue;
        const matches = s.match(/\d+/g);
        if (!matches) continue;
        for (const m of matches) {
          const code = m.slice(-4);
          if (code.length >= 1 && code.length <= 4) out.push(code);
        }
      }
      return [...new Set(out)].sort((a,b)=>a.localeCompare(b));
    }

    async function parseVinsFromCSV(file) {
      const text = await file.text();
      const values = text.split(/,|\n|\r|\t|;/g);
      return extract4DigitCodes(values);
    }

    async function parseVinsFromXLSX(file) {
      const buf = await file.arrayBuffer();
      const data = new Uint8Array(buf);
      const wb = XLSX.read(data, { type: "array" });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
      return extract4DigitCodes(rows.flat());
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    }

    // init
    (async () => {
      setRealtimeStatus("초기 로딩...");
      await loadAll();
      subscribeRealtime();
    })();
  </script>
</body>
</html>
