<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SP3 광주 대상 조치 VIN 리스트</title>
  <style>
    body{font-family:system-ui,-apple-system;margin:18px;line-height:1.35}
    .box{border:1px solid #ddd;border-radius:14px;padding:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,button,textarea{border:1px solid #ccc;border-radius:12px;padding:10px;font-size:14px}
    button{background:#f6f6f6}
    button:disabled{opacity:.55}
    .pill{border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-size:13px}
    .list{margin-top:14px;display:flex;flex-direction:column;gap:10px}
    .card{border:1px solid #e3e3e3;border-radius:16px;padding:12px}
    .vin{font-size:26px;font-weight:800}
    .muted{color:#666;font-size:13px}
    .tabs button{border-radius:999px;padding:8px 12px}
    .tabs button.active{background:#111;color:#fff;border-color:#111}
    .right{margin-left:auto}
    /* 하단 고정 탭 바 */
/* ✅ 하단 고정 탭 버튼을 "균등 폭"으로 (폰에서 좌우 꽉 차게) */
#bottomTabs{
  display: flex;
  width: 100%;
  gap: 8px;
}
#bottomTabs button{
  flex: 1;                /* 버튼 너비를 동일하게 */
  text-align: center;
  white-space: nowrap;    /* 글자 줄바꿈 방지 */
}
.bottomBar{
  position: fixed;
  left: 0; right: 0; bottom: 0;
  background: #fff;
  border-top: 1px solid #ddd;
  padding: 10px 12px;
  z-index: 9999;
}
.bottomInner{
  max-width: 980px;
  margin: 0 auto;
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
    
body{ padding-bottom: 86px; } /* 하단바 때문에 내용 가리지 않게 여백 */
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
</head>
<body>
  <h2>SP3 광주공장 대상 조치 VIN 현황</h2>

  <div class="box">
    <div class="row" style="justify-content:space-between">
      <div>사용자: <b id="nickLabel">(미설정)</b></div>
      <div class="row">
        <button id="nickBtn">닉네임 변경</button>
        <button id="downloadBtn">엑셀 다운로드(XLSX)</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <input id="search" placeholder="VIN 검색(4자리)" inputmode="numeric" style="width:150px"/>
      <span class="pill" id="cntTotal">총 -</span>
      <span class="pill" id="cntDone">완료 -</span>
      <span class="pill" id="cntRemain">잔여 -</span>
      <div style="margin-top:10px">
  <div class="muted">완료율: <b id="pctText">-</b></div>
  <div style="height:12px;border:1px solid #ddd;border-radius:999px;overflow:hidden">
    <div id="pctBar" style="height:100%;width:0%"></div>
  </div>
</div>
      <span class="muted" id="saving"></span>
      <span class="right muted" id="rt"></span>
    </div>

<div class="row tabs" style="margin-top:10px" id="topTabs">
  <button data-tab="all" class="active">전체</button>
  <button data-tab="작업중">작업중</button>
  <button data-tab="완료">완료</button>
  <button data-tab="기타">기타</button>
  <button data-tab="remain">미완료</button>
  <button data-tab="mine">내 작업</button>
  <button data-tab="recent">최근 변경</button>
</div>
  </div>

  <div class="list" id="list"></div>

<script>
/* ======= 너 설정(필수) ======= */
const SUPABASE_URL = "https://gpdtgrbiyrgekjtgxpgf.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdwZHRncmJpeXJnZWtqdGd4cGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1ODI3ODAsImV4cCI6MjA4NTE1ODc4MH0.tLZb3obtmHgWMTiKf4xhbsiOqmg80o2MPibQhB5Ywco";
const TABLE_NAME = "checklist";
/* ============================ */

let NICK = localStorage.getItem("checklist_nick") || "";
let tab = "all";
let items = [];
let saving = false;

const $ = (id)=>document.getElementById(id);

function mustNick(){
  while(!NICK){
    const n = prompt("닉네임을 입력하세요 (예: 신영/홍길동)");
    if(!n) continue;
    NICK = n.trim();
    localStorage.setItem("checklist_nick", NICK);
  }
  $("nickLabel").innerText = NICK;
}
$("nickBtn").onclick = ()=>{
  NICK = "";
  localStorage.removeItem("checklist_nick");
  mustNick();
};

function headers(preferReturn=true){
  const h = {
    "apikey": SUPABASE_ANON_KEY,
    "Authorization": "Bearer " + SUPABASE_ANON_KEY,
    "Content-Type": "application/json",
  };
  if(preferReturn) h["Prefer"] = "return=representation";
  return h;
}

function setSaving(v){
  saving=v;
  $("saving").innerText = v ? "저장중..." : "";
  document.querySelectorAll("button").forEach(b=>b.disabled = v);
  $("nickBtn").disabled = false;
}

async function load(){
  const url = `${SUPABASE_URL}/rest/v1/${TABLE_NAME}?select=*`;
  const r = await fetch(url, {headers: headers(true)});
  if(!r.ok){
    $("rt").innerText = "로드 실패";
    console.log(await r.text());
    return;
  }
  items = await r.json();
  $("rt").innerText = "연결됨 ✅";
  let lastAction = null; // {id, prev, timer}
function showToast(msg){
  const t = document.getElementById("toast");
  document.getElementById("toastMsg").innerText = msg;
  t.style.display = "flex";
}
function hideToast(){
  const t = document.getElementById("toast");
  t.style.display = "none";
}
document.getElementById("undoBtn").onclick = async ()=>{
  if(!lastAction) return;
  clearTimeout(lastAction.timer);
  const {id, prev} = lastAction;
  lastAction = null;
  hideToast();
  await patchItem(id, prev, /*skipUndo*/ true);
};
  render();
}

function normStatus(s){
  s = (s || "").toString().trim();

  // ✅ 잔여/남음/미완료 계열은 전부 '미완료'로 통일
  if (s === "" || s === "잔여" || s === "남음" || s === "remain" || s === "미완" || s === "미완료") return "미완료";

  if (s === "작업중") return "작업중";
  if (s === "완료") return "완료";
  if (s === "기타") return "기타";

  // 혹시 다른 값이면 기타 처리(원하면 미완료로 바꿔도 됨)
  return s;
}

function formatKST(iso){
  if(!iso) return "-";
  const d = new Date(iso);
  return new Intl.DateTimeFormat("ko-KR", {
    timeZone: "Asia/Seoul",
    year: "numeric", month: "2-digit", day: "2-digit",
    hour: "2-digit", minute: "2-digit", second: "2-digit",
    hour12: false
  }).format(d);
}

function render(){
  const q = $("search").value.trim();
  let view = items.map(x=>({...x, status:normStatus(x.status)}));

  if(tab !== "all"){
  if(tab === "remain"){
  // ✅ 미완료만
  view = view.filter(x => normStatus(x.status) === "미완료");
} else if(tab === "mine"){
    // 내 작업 = 내가 마지막으로 건드렸거나(업데이트), 내가 완료한 것
    view = view.filter(x =>
      (x.updated_by || "") === NICK || (x.completed_by || "") === NICK
    );
 } else if(tab === "recent"){
  // 최근 변경 = 최근 30분 이내 updated_at
  const since = Date.now() - 30*60*1000;
  view = view.filter(x =>
    x.updated_at && (new Date(x.updated_at).getTime() >= since)
  );

  // ✅ 추가: 최신순 정렬
  view.sort((a, b) =>
    new Date(b.updated_at).getTime() - new Date(a.updated_at).getTime()
  );
}
 else {
    // 작업중/완료/기타 같은 일반 탭
    view = view.filter(x => normStatus(x.status) === tab);
  }
}

  if(q) view = view.filter(x=>String(x.vin).includes(q));

  const order = {"작업중":1,"완료":2,"기타":3};
  view.sort((a,b)=>(order[a.status]||9)-(order[b.status]||9) || String(a.vin).localeCompare(String(b.vin)));

  const total = items.length;
  const done = items.filter(x=>normStatus(x.status)==="완료").length;
  $("cntTotal").innerText = `총 ${total}`;
  $("cntDone").innerText = `완료 ${done}`;
  $("cntRemain").innerText = `잔여 ${total-done}`;
    const pct = total ? Math.round((done / total) * 100) : 0;
  $("pctText").innerText = pct + "%";
  $("pctBar").style.width = pct + "%";

  const box = $("list");
  box.innerHTML="";
  view.forEach(it=>{
    const d = document.createElement("div");
    d.className="card";
    const completedText = formatKST(it.completed_at);
    const completedBy = it.completed_by || "-";
    const updatedText = formatKST(it.updated_at);
    const updatedBy = it.updated_by || "-";

    d.innerHTML = `
      <div class="vin">${it.vin}</div>
      <div class="muted">상태: <b>${normStatus(it.status)}</b></div>
      <div class="muted">완료: ${completedText} · ${completedBy}</div>
      <div class="muted">최근변경: ${updatedText} · ${updatedBy}</div>
      <div class="muted">메모: ${it.memo ? it.memo : "-"}</div>
      <div class="row" style="margin-top:10px">
        <button onclick="setStatus('${it.id}','미완료')">미완료</button>
        <button onclick="setStatus('${it.id}','작업중')">작업중</button>
        <button onclick="setStatus('${it.id}','완료')">완료</button>
        <button onclick="setStatus('${it.id}','기타')">기타</button>
      </div>
    `;
    box.appendChild(d);
  });
}

async function setStatus(id, status){
  mustNick();
  setSaving(true);
  let memoValue = null;

  // ✅ 기타 누르면 메모 입력 (취소하면 아무 것도 안 함)
  if(status === "기타"){
    const cur = items.find(x => x.id === id);
    const prevMemo = cur?.memo || "";
    const m = prompt("특이사항 메모 입력", prevMemo);
    if(m === null){
      setSaving(false);
      return;
    }
    memoValue = m.trim();
  }

  const payload = {
    status,
    updated_by: NICK,
    updated_at: new Date().toISOString()
  };
  if(status === "기타"){
    payload.memo = memoValue;
  }

  if(status==="완료"){
    payload.completed_by = NICK;
    payload.completed_at = new Date().toISOString();
  }else{
    payload.completed_by = null;
    payload.completed_at = null;
  }

  const url = `${SUPABASE_URL}/rest/v1/${TABLE_NAME}?id=eq.${encodeURIComponent(id)}`;
  const r = await fetch(url, {method:"PATCH", headers: headers(true), body: JSON.stringify(payload)});
  setSaving(false);

  if(!r.ok){
    alert("저장 실패. 콘솔/권한/RLS 확인 필요");
    console.log(await r.text());
    return;
  }
  await load();
}

function toCSV(rows){
  const header = ["vin","status","memo","updated_by","updated_at","completed_by","completed_at"];
  const esc = (v)=> `"${String(v??"").replaceAll('"','""')}"`;
  const lines = [header.join(",")];
  rows.forEach(r=>{
    lines.push([
      esc(r.vin),
      esc(normStatus(r.status)),
      esc(r.memo),
      esc(r.updated_by),
      esc(r.updated_at),
      esc(r.completed_by),
      esc(r.completed_at),
    ].join(","));
  });
  return lines.join("\n");
}

$("downloadBtn").onclick = ()=>{
  // 1) 엑셀에 넣을 데이터 만들기 (한국시간 문자열)
  const rows = items.map(r => ({
    vin: r.vin,
    status: (typeof normStatus === "function" ? normStatus(r.status) : (r.status || "")),
    memo: r.memo || "",
    updated_by: r.updated_by || "",
    updated_at: formatKST(r.updated_at),
    completed_by: r.completed_by || "",
    completed_at: formatKST(r.completed_at),
  }));

  // 2) 헤더 + 데이터
  const header = ["VIN","상태","메모","최근변경자","최근변경시간(KST)","완료자","완료시간(KST)"];
  const aoa = [header, ...rows.map(x => [
    x.vin, x.status, x.memo, x.updated_by, x.updated_at, x.completed_by, x.completed_at
  ])];

  // 3) 시트 생성
  const ws = XLSX.utils.aoa_to_sheet(aoa);

  // 4) 컬럼 너비
  ws["!cols"] = [
    { wch: 10 }, { wch: 8 }, { wch: 30 }, { wch: 12 },
    { wch: 22 }, { wch: 12 }, { wch: 22 }
  ];

  // 5) 스타일(헤더 + 상태별 색)
  const range = XLSX.utils.decode_range(ws["!ref"]);

  // 헤더 스타일
  for(let C = range.s.c; C <= range.e.c; ++C){
    const addr = XLSX.utils.encode_cell({r:0, c:C});
    if(ws[addr]){
      ws[addr].s = {
        font: { bold: true, color: { rgb: "FFFFFF" } },
        fill: { fgColor: { rgb: "111111" } },
        alignment: { horizontal: "center", vertical: "center" }
      };
    }
  }

  // 상태별 행 배경색
  const colorByStatus = {
    "완료": "C6EFCE",   // 초록
    "작업중": "D9E1F2", // 파랑
    "기타": "FFF2CC"    // 노랑
  };

  for(let R = 1; R <= range.e.r; ++R){
    const sAddr = XLSX.utils.encode_cell({r:R, c:1}); // 상태 컬럼(B)
    const statusVal = ws[sAddr]?.v;
    const fillColor = colorByStatus[statusVal];
    if(fillColor){
      for(let C = range.s.c; C <= range.e.c; ++C){
        const addr = XLSX.utils.encode_cell({r:R, c:C});
        if(ws[addr]){
          ws[addr].s = ws[addr].s || {};
          ws[addr].s.fill = { fgColor: { rgb: fillColor } };
        }
      }
    }
  }

  // 6) 파일 생성/다운로드
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Checklist");

  const stamp = new Date().toISOString().slice(0,19).replaceAll(":","-");
  XLSX.writeFile(wb, `checklist_${stamp}.xlsx`);
};


$("search").oninput = render;
function setActiveTabs(newTab){
  tab = newTab;

  // 위/아래 탭 모두 active 동기화
  document.querySelectorAll("#topTabs button, #bottomTabs button").forEach(btn=>{
    btn.classList.toggle("active", btn.dataset.tab === newTab);
  });

  render();
}

// 위/아래 탭 클릭 연결 (DOM 다 만들어진 다음에 연결)
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll('#topTabs button, #bottomTabs button').forEach(btn => {
    btn.onclick = () => setActiveTabs(btn.dataset.tab);
  });

  mustNick();
  load();
});
</script>
  <div class="bottomBar">
  <div class="bottomInner tabs" id="bottomTabs">
    <button data-tab="all" class="active">전체</button>
    <button data-tab="작업중">작업중</button>
    <button data-tab="완료">완료</button>
    <button data-tab="기타">기타</button>
    <button data-tab="remain">미완료</button>
    <button data-tab="mine">내 작업</button>
    <button data-tab="recent">최근 변경</button>
  </div>
</div>
  <div id="toast" style="position:fixed;left:50%;bottom:96px;transform:translateX(-50%);
display:none;gap:10px;align-items:center;background:#111;color:#fff;padding:10px 12px;border-radius:14px;z-index:10000">
  <span id="toastMsg">저장됨</span>
  <button id="undoBtn" style="background:#fff;color:#111;border:none;border-radius:12px;padding:8px 10px">되돌리기(5초)</button>
</div>
</body>
</html>









