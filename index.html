<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>대상 조치 체크리스트</title>
  <style>
    body{font-family:system-ui,-apple-system;margin:18px;line-height:1.35}
    .box{border:1px solid #ddd;border-radius:14px;padding:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,button,textarea{border:1px solid #ccc;border-radius:12px;padding:10px;font-size:14px}
    button{background:#f6f6f6}
    button:disabled{opacity:.55}
    .pill{border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-size:13px}
    .list{margin-top:14px;display:flex;flex-direction:column;gap:10px}
    .card{border:1px solid #e3e3e3;border-radius:16px;padding:12px}
    .vin{font-size:26px;font-weight:800}
    .muted{color:#666;font-size:13px}
    .tabs button{border-radius:999px;padding:8px 12px}
    .tabs button.active{background:#111;color:#fff;border-color:#111}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <h2>대상 조치 체크리스트</h2>

  <div class="box">
    <div class="row" style="justify-content:space-between">
      <div>사용자: <b id="nickLabel">(미설정)</b></div>
      <div class="row">
        <button id="nickBtn">닉네임 변경</button>
        <button id="downloadBtn">엑셀 다운로드(CSV)</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <input id="search" placeholder="VIN 검색(4자리)" inputmode="numeric" style="width:150px"/>
      <span class="pill" id="cntTotal">총 -</span>
      <span class="pill" id="cntDone">완료 -</span>
      <span class="pill" id="cntRemain">잔여 -</span>
      <span class="muted" id="saving"></span>
      <span class="right muted" id="rt"></span>
    </div>

    <div class="row tabs" style="margin-top:10px">
      <button data-tab="all" class="active">전체</button>
      <button data-tab="미완료">미완료</button>
      <button data-tab="작업중">작업중</button>
      <button data-tab="완료">완료</button>
    </div>
  </div>

  <div class="list" id="list"></div>

<script>
/* ======= 너 설정(필수) ======= */
const SUPABASE_URL = "https://gpdtgrbiyrgekjtgxpgf.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdwZHRncmJpeXJnZWtqdGd4cGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1ODI3ODAsImV4cCI6MjA4NTE1ODc4MH0.tLZb3obtmHgWMTiKf4xhbsiOqmg80o2MPibQhB5Ywco";
const TABLE_NAME = "checklist";
/* ============================ */

let NICK = localStorage.getItem("checklist_nick") || "";
let tab = "all";
let items = [];
let saving = false;

const $ = (id)=>document.getElementById(id);

function mustNick(){
  while(!NICK){
    const n = prompt("닉네임을 입력하세요 (예: 신영/홍길동)");
    if(!n) continue;
    NICK = n.trim();
    localStorage.setItem("checklist_nick", NICK);
  }
  $("nickLabel").innerText = NICK;
}
$("nickBtn").onclick = ()=>{
  NICK = "";
  localStorage.removeItem("checklist_nick");
  mustNick();
};

function headers(preferReturn=true){
  const h = {
    "apikey": SUPABASE_ANON_KEY,
    "Authorization": "Bearer " + SUPABASE_ANON_KEY,
    "Content-Type": "application/json",
  };
  if(preferReturn) h["Prefer"] = "return=representation";
  return h;
}

function setSaving(v){
  saving=v;
  $("saving").innerText = v ? "저장중..." : "";
  document.querySelectorAll("button").forEach(b=>b.disabled = v);
  $("nickBtn").disabled = false;
}

async function load(){
  const url = `${SUPABASE_URL}/rest/v1/${TABLE_NAME}?select=*`;
  const r = await fetch(url, {headers: headers(true)});
  if(!r.ok){
    $("rt").innerText = "로드 실패";
    console.log(await r.text());
    return;
  }
  items = await r.json();
  $("rt").innerText = "연결됨 ✅";
  render();
}

function normStatus(s){
  if(s==="open") return "미완료";
  if(s==="doing") return "작업중";
  if(s==="done") return "완료";
  return s || "미완료";
}

function render(){
  const q = $("search").value.trim();
  let view = items.map(x=>({...x, status:normStatus(x.status)}));

  if(tab!=="all") view = view.filter(x=>x.status===tab);
  if(q) view = view.filter(x=>String(x.vin).includes(q));

  const order = {"미완료":1,"작업중":2,"완료":3};
  view.sort((a,b)=>(order[a.status]||9)-(order[b.status]||9) || String(a.vin).localeCompare(String(b.vin)));

  const total = items.length;
  const done = items.filter(x=>normStatus(x.status)==="완료").length;
  $("cntTotal").innerText = `총 ${total}`;
  $("cntDone").innerText = `완료 ${done}`;
  $("cntRemain").innerText = `잔여 ${total-done}`;

  const box = $("list");
  box.innerHTML="";
  view.forEach(it=>{
    const d = document.createElement("div");
    d.className="card";
    const completedText = it.completed_at ? new Date(it.completed_at).toLocaleString() : "-";
    const completedBy = it.completed_by || "-";
    const updatedText = it.updated_at ? new Date(it.updated_at).toLocaleString() : "-";
    const updatedBy = it.updated_by || "-";

    d.innerHTML = `
      <div class="vin">${it.vin}</div>
      <div class="muted">상태: <b>${normStatus(it.status)}</b></div>
      <div class="muted">완료: ${completedText} · ${completedBy}</div>
      <div class="muted">최근변경: ${updatedText} · ${updatedBy}</div>
      <div class="row" style="margin-top:10px">
        <button onclick="setStatus('${it.id}','미완료')">미완료</button>
        <button onclick="setStatus('${it.id}','작업중')">작업중</button>
        <button onclick="setStatus('${it.id}','완료')">완료</button>
      </div>
    `;
    box.appendChild(d);
  });
}

async function setStatus(id, status){
  mustNick();
  setSaving(true);

  const payload = {
    status,
    updated_by: NICK,
    updated_at: new Date().toISOString()
  };

  if(status==="완료"){
    payload.completed_by = NICK;
    payload.completed_at = new Date().toISOString();
  }else{
    payload.completed_by = null;
    payload.completed_at = null;
  }

  const url = `${SUPABASE_URL}/rest/v1/${TABLE_NAME}?id=eq.${encodeURIComponent(id)}`;
  const r = await fetch(url, {method:"PATCH", headers: headers(true), body: JSON.stringify(payload)});
  setSaving(false);

  if(!r.ok){
    alert("저장 실패. 콘솔/권한/RLS 확인 필요");
    console.log(await r.text());
    return;
  }
  await load();
}

function toCSV(rows){
  const header = ["vin","status","memo","updated_by","updated_at","completed_by","completed_at"];
  const esc = (v)=> `"${String(v??"").replaceAll('"','""')}"`;
  const lines = [header.join(",")];
  rows.forEach(r=>{
    lines.push([
      esc(r.vin),
      esc(normStatus(r.status)),
      esc(r.memo),
      esc(r.updated_by),
      esc(r.updated_at),
      esc(r.completed_by),
      esc(r.completed_at),
    ].join(","));
  });
  return lines.join("\n");
}

$("downloadBtn").onclick = ()=>{
  const csv = toCSV(items);
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const stamp = new Date().toISOString().slice(0,19).replaceAll(":","-");
  a.href = url;
  a.download = `checklist_${stamp}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
};

$("search").oninput = render;
document.querySelectorAll(".tabs button").forEach(b=>{
  b.onclick = ()=>{
    document.querySelectorAll(".tabs button").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    tab = b.dataset.tab;
    render();
  };
});

mustNick();
load();
</script>
</body>
</html>
