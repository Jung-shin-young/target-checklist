<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>QV CR RADAR VIN LIST</title>
  <style>
    body{font-family:system-ui,-apple-system;margin:18px;line-height:1.35}
    .box{border:1px solid #ddd;border-radius:14px;padding:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,button,textarea{border:1px solid #ccc;border-radius:12px;padding:10px;font-size:14px}
    button{background:#f6f6f6}
    button:disabled{opacity:.55}
    .pill{border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-size:13px}
    .list{margin-top:14px;display:flex;flex-direction:column;gap:10px}
    .card{border:1px solid #e3e3e3;border-radius:16px;padding:12px}
    .vin{font-size:26px;font-weight:800}
    .muted{color:#666;font-size:13px}
    .tabs button{border-radius:999px;padding:8px 12px}
    .tabs button.active{background:#111;color:#fff;border-color:#111}
    .right{margin-left:auto}

    /* ✅ Bottom fixed tab bar */
    #bottomTabs{display:flex;width:100%;gap:8px}
    #bottomTabs button{flex:1;text-align:center;white-space:nowrap;}
    .bottomBar{
      position:fixed;left:0; right:0; bottom:0;
      background:#fff;border-top:1px solid #ddd;
      padding:10px 12px;z-index:9999;
    }
    .bottomInner{
      max-width:980px;margin:0 auto;
      display:flex;gap:8px;flex-wrap:wrap;
    }
    body{padding-bottom:86px;}

    @media (max-width: 520px) {
      .summaryRow{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
      .summaryRow #search{width:100% !important;box-sizing:border-box}
      .summaryPct{width:100%}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
</head>
<body>
  <h2>QV CR RADAR VIN LIST</h2>

  <!--
  ✅ RUN ONCE in Supabase SQL Editor (TABLE_NAME = checklist_en)
  -------------------------------------------------------------
  alter table public.checklist_en
    add column if not exists update_done boolean default false,
    add column if not exists dtc_done boolean default false,
    add column if not exists update_by text,
    add column if not exists update_at timestamptz,
    add column if not exists dtc_by text,
    add column if not exists dtc_at timestamptz;
  -->

  <div class="box">
    <div class="row" style="justify-content:space-between">
      <div>User: <b id="nickLabel">(not set)</b></div>
      <div class="row">
        <button id="nickBtn">Nickname</button>
        <button id="downloadBtn">Excel (XLSX)</button>
      </div>
    </div>

    <div class="row summaryRow" style="margin-top:10px">
      <input id="search" placeholder="Search VIN (last 4 digits)" inputmode="numeric" style="width:210px"/>
      <span class="pill" id="cntTotal">Total -</span>
      <span class="pill" id="cntUpd">Updated -</span>
      <span class="pill" id="cntDtc">Checked -</span>
      <span class="pill" id="cntRemain">Remaining -</span>

      <div class="summaryPct" style="margin-top:10px;width:100%">
        <div class="muted" style="margin-bottom:6px">
          Update Rate: <b id="pctUpdText">-</b>
        </div>
        <div style="height:12px;border:1px solid #ddd;border-radius:999px;overflow:hidden;background:#eee">
          <div id="updBar" style="height:100%;width:0%;background:linear-gradient(90deg,#4f8cff,#2563eb);transition:width .25s ease"></div>
        </div>

        <div style="height:10px"></div>

        <div class="muted" style="margin-bottom:6px">
          DTC Check Rate (Final): <b id="pctText">-</b>
        </div>
        <div style="height:12px;border:1px solid #ddd;border-radius:999px;overflow:hidden;background:#eee">
          <div id="pctBar" style="height:100%;width:0%;background:linear-gradient(90deg,#4caf50,#2e7d32);transition:width .25s ease"></div>
        </div>
      </div>

      <span class="muted" id="saving"></span>
      <span class="right muted" id="rt"></span>
    </div>

    <!-- ✅ TOP TABS -->
    <div class="row tabs" style="margin-top:10px" id="topTabs">
      <button data-tab="all" class="active">All</button>
      <!-- order: In progress / Updated / DTC / Other / Not started -->
      <button data-tab="In progress">In progress</button>
      <button data-tab="Updated">Updated</button>
      <button data-tab="Checked">DTC</button>
      <button data-tab="Other">Other</button>
      <button data-tab="Not started">Not started</button>
    </div>
  </div>

  <div class="list" id="list"></div>

<script>
/* ======= CONFIG ======= */
const SUPABASE_URL = "https://gpdtgrbiyrgekjtgxpgf.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdwZHRncmJpeXJnZWtqdGd4cGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1ODI3ODAsImV4cCI6MjA4NTE1ODc4MH0.tLZb3obtmHgWMTiKf4xhbsiOqmg80o2MPibQhB5Ywco";
const TABLE_NAME = "checklist_en";
/* ====================== */

let NICK = localStorage.getItem("checklist_nick") || "";
let tab = "all";
let items = [];
let saving = false;

const $ = (id)=>document.getElementById(id);

function mustNick(){
  while(!NICK){
    const n = prompt("Enter your nickname (e.g., ShinYoung / Hong Gil-dong)");
    if(!n) continue;
    NICK = n.trim();
    localStorage.setItem("checklist_nick", NICK);
  }
  $("nickLabel").innerText = NICK;
}
$("nickBtn").onclick = ()=>{
  NICK = "";
  localStorage.removeItem("checklist_nick");
  mustNick();
};

function headers(preferReturn=true){
  const h = {
    "apikey": SUPABASE_ANON_KEY,
    "Authorization": "Bearer " + SUPABASE_ANON_KEY,
    "Content-Type": "application/json",
  };
  if(preferReturn) h["Prefer"] = "return=representation";
  return h;
}

function setSaving(v){
  saving=v;
  $("saving").innerText = v ? "Saving..." : "";
  document.querySelectorAll("button").forEach(b=>b.disabled = v);
  $("nickBtn").disabled = false;
}

const BASE_STATUS = {
  NOT_STARTED: "Not started",
  IN_PROGRESS: "In progress",
  OTHER: "Other",
};

function normBaseStatus(s){
  s = (s || "").toString().trim();
  if (s === "" || s === "remain" || s === "Not started" || s === "잔여" || s === "미완" || s === "미완료") return BASE_STATUS.NOT_STARTED;
  if (s === "작업중") return BASE_STATUS.IN_PROGRESS;
  if (s === "기타") return BASE_STATUS.OTHER;

  // Old workflow strings (if any old rows exist)
  if (s === "Update completed" || s === "업데이트 완료") return BASE_STATUS.IN_PROGRESS;
  if (s === "DTC check" || s === "완료") return BASE_STATUS.IN_PROGRESS;

  if (s === BASE_STATUS.NOT_STARTED) return BASE_STATUS.NOT_STARTED;
  if (s === BASE_STATUS.IN_PROGRESS) return BASE_STATUS.IN_PROGRESS;
  if (s === BASE_STATUS.OTHER) return BASE_STATUS.OTHER;
  return BASE_STATUS.OTHER;
}

function formatKST(iso){
  if(!iso) return "-";
  const d = new Date(iso);
  return new Intl.DateTimeFormat("en-GB", {
    timeZone: "Asia/Seoul",
    year: "numeric", month: "2-digit", day: "2-digit",
    hour: "2-digit", minute: "2-digit", second: "2-digit",
    hour12: false
  }).format(d);
}

/* Backward-compatible "effective" flags */
function effUpdateDone(it){
  if (typeof it.update_done === "boolean") return it.update_done;
  const s = (it.status || "").toString().trim();
  return (s === "Update completed" || s === "업데이트 완료" || s === "DTC check" || s === "완료");
}
function effDtcDone(it){
  if (typeof it.dtc_done === "boolean") return it.dtc_done;
  const s = (it.status || "").toString().trim();
  return (s === "DTC check" || s === "완료");
}

function derivedState(it){
  const base = normBaseStatus(it.status);
  const upd = effUpdateDone(it);
  const dtc = effDtcDone(it);

  if (base === BASE_STATUS.OTHER) return "Other";
  if (dtc) return "Checked";
  if (upd) return "Updated";
  if (base === BASE_STATUS.IN_PROGRESS) return "In progress";
  return "Not started";
}

async function load(){
  const url = `${SUPABASE_URL}/rest/v1/${TABLE_NAME}?select=*`;
  const r = await fetch(url, {headers: headers(true)});
  if(!r.ok){
    $("rt").innerText = "Load failed";
    console.log(await r.text());
    return;
  }
  items = await r.json();
  $("rt").innerText = "Connected ✅";
  render();
}

function render(){
  const q = $("search").value.trim();

  let view = items.map(x=>({
    ...x,
    _base: normBaseStatus(x.status),
    _upd: effUpdateDone(x),
    _dtc: effDtcDone(x),
    _state: derivedState(x),
  }));

  if(tab !== "all"){
    if(tab === "mine"){
      view = view.filter(x =>
        (x.update_by || x.updated_by || "") === NICK ||
        (x.dtc_by || x.completed_by || "") === NICK
      );
      view.sort((a,b)=>
        new Date((b.dtc_at || b.completed_at || b.update_at || b.updated_at || 0)).getTime() -
        new Date((a.dtc_at || a.completed_at || a.update_at || a.updated_at || 0)).getTime()
      );
    } else if(tab === "recent"){
      const since = Date.now() - 30*60*1000;
      view = view.filter(x => {
        const t = x.dtc_at || x.completed_at || x.update_at || x.updated_at || null;
        return t && (new Date(t).getTime() >= since);
      });
      view.sort((a,b)=>
        new Date((b.dtc_at || b.completed_at || b.update_at || b.updated_at)).getTime() -
        new Date((a.dtc_at || a.completed_at || a.update_at || a.updated_at)).getTime()
      );
    } else {
      view = view.filter(x => x._state === tab);
    }
  }

  if(q) view = view.filter(x=>String(x.vin).includes(q));

  const order = { "In progress": 1, "Updated": 2, "Checked": 3, "Other": 4, "Not started": 5 };
  view.sort((a,b)=>
    (order[a._state]||9)-(order[b._state]||9) ||
    String(a.vin).localeCompare(String(b.vin))
  );

  // ✅ Separate counts (Updated & Checked can overlap)
  const total = items.length;
  const updatedCnt = items.filter(x => effUpdateDone(x)).length;
  const checkedCnt = items.filter(x => effDtcDone(x)).length;
  const remain = Math.max(0, total - checkedCnt);

  $("cntTotal").innerText = `Total ${total}`;
  $("cntUpd").innerText   = `Updated ${updatedCnt}`;
  $("cntDtc").innerText   = `Checked ${checkedCnt}`;
  $("cntRemain").innerText= `Remaining ${remain}`;

  const pctUpd = total ? Math.round((updatedCnt / total) * 100) : 0;
  const pctDtc = total ? Math.round((checkedCnt / total) * 100) : 0;

  $("pctUpdText").innerText = pctUpd + "%";
  $("updBar").style.width = pctUpd + "%";

  $("pctText").innerText = pctDtc + "%";
  $("pctBar").style.width = pctDtc + "%";

  const box = $("list");
  box.innerHTML="";

  view.forEach(it=>{
    const d = document.createElement("div");
    d.className="card";

    const updBy = it.update_by || "-";
    const updAt = it.update_at || null;

    const dtcBy = it.dtc_by || "-";
    const dtcAt = it.dtc_at || null;

    const lastBy = it.updated_by || "-";
    const lastAt = it.updated_at || null;

    const memoText = (it.memo ? it.memo : "-");
    const stateLabel = it._state;

    const updMark = it._upd ? "✅" : "⬜";
    const dtcMark = it._dtc ? "✅" : "⬜";

    d.innerHTML = `
      <div class="vin">${it.vin}</div>
      <div class="muted">State: <b>${stateLabel}</b></div>

      <div class="muted">Update: ${updMark} ${formatKST(updAt)} · ${updBy}</div>
      <div class="muted">DTC: ${dtcMark} ${formatKST(dtcAt)} · ${dtcBy}</div>
      <div class="muted">Last change: ${formatKST(lastAt)} · ${lastBy}</div>
      <div class="muted">Memo: ${memoText}</div>


      <div class="row" style="margin-top:10px">
        <button onclick="setBaseStatus('${it.id}','${BASE_STATUS.NOT_STARTED}')">Not started</button>
        <button onclick="setBaseStatus('${it.id}','${BASE_STATUS.IN_PROGRESS}')">In progress</button>

        <!-- ✅ Toggle buttons -->
        <button onclick="toggleUpdate('${it.id}')">Updated</button>
        <button onclick="toggleDtc('${it.id}')">DTC Checked</button>

        <button onclick="setOther('${it.id}')">Other</button>
      </div>
    `;
    box.appendChild(d);
  });
}

// ---------- SAVE HELPERS ----------
async function patchRow(id, payload){
  const url = `${SUPABASE_URL}/rest/v1/${TABLE_NAME}?id=eq.${encodeURIComponent(id)}`;
  const r = await fetch(url, {method:"PATCH", headers: headers(true), body: JSON.stringify(payload)});
  if(!r.ok){
    alert("Save failed. Check console / permissions / RLS.");
    console.log(await r.text());
    return false;
  }
  return true;
}

async function setBaseStatus(id, baseStatus){
  mustNick();
  setSaving(true);

  const payload = {
    status: baseStatus,
    updated_by: NICK,
    updated_at: new Date().toISOString()
  };

  const ok = await patchRow(id, payload);
  setSaving(false);
  if(ok) await load();
}

async function setOther(id){
  mustNick();
  const cur = items.find(x => x.id === id);
  const prevMemo = cur?.memo || "";
  const m = prompt("Enter memo (Other)", prevMemo);
  if(m === null) return;

  setSaving(true);
  const payload = {
    status: BASE_STATUS.OTHER,
    memo: m.trim(),
    updated_by: NICK,
    updated_at: new Date().toISOString()
  };
  const ok = await patchRow(id, payload);
  setSaving(false);
  if(ok) await load();
}

/* ✅ Toggle Update: true <-> false (independent from DTC) */
async function toggleUpdate(id){
  mustNick();
  const cur = items.find(x => x.id === id);
  const currUpd = cur ? effUpdateDone(cur) : false;
  const nextUpd = !currUpd;

  setSaving(true);
  const now = new Date().toISOString();

  const payload = {
    update_done: nextUpd,
    update_by: nextUpd ? NICK : null,
    update_at: nextUpd ? now : null,

    // keep old fields for visibility / legacy
    updated_by: NICK,
    updated_at: now,
  };

  // If toggling ON and base is Not started -> bump to In progress
  const base = normBaseStatus(cur?.status);
  if(nextUpd && base === BASE_STATUS.NOT_STARTED) payload.status = BASE_STATUS.IN_PROGRESS;

  const ok = await patchRow(id, payload);
  setSaving(false);
  if(ok) await load();
}

/* ✅ Toggle DTC:
   - If turning ON: Update must be true, otherwise blocked + alert (English)
   - If turning OFF: confirm popup, Update stays as-is (separate work)
*/
async function toggleDtc(id){
  mustNick();
  const cur = items.find(x => x.id === id);
  const currDtc = cur ? effDtcDone(cur) : false;
  const nextDtc = !currDtc;

  // turning ON requires Update done
  if(nextDtc){
    const upd = cur ? effUpdateDone(cur) : false;
    if(!upd){
      alert("Update is not completed yet. Please complete Update first.");
      return;
    }
  } else {
    // turning OFF => confirm
    const okConfirm = confirm("Are you sure you want to UNCHECK DTC?");
    if(!okConfirm) return;
  }

  setSaving(true);
  const now = new Date().toISOString();

  const payload = {
    dtc_done: nextDtc,
    dtc_by: nextDtc ? NICK : null,
    dtc_at: nextDtc ? now : null,

    // legacy completion fields
    completed_by: nextDtc ? NICK : null,
    completed_at: nextDtc ? now : null,

    updated_by: NICK,
    updated_at: now,
  };

  const ok = await patchRow(id, payload);
  setSaving(false);
  if(ok) await load();
}

// ---------- DOWNLOAD ----------
$("downloadBtn").onclick = ()=>{
  const rows = items.map(r => {
    const base = normBaseStatus(r.status);
    const upd = effUpdateDone(r);
    const dtc = effDtcDone(r);
    const state = derivedState(r);

    return ({
      vin: r.vin,
      state,
      base_status: base,
      update_done: upd ? "Y" : "N",
      update_by: r.update_by || r.updated_by || "",
      update_at: formatKST(r.update_at || r.updated_at),
      dtc_done: dtc ? "Y" : "N",
      dtc_by: r.dtc_by || r.completed_by || "",
      dtc_at: formatKST(r.dtc_at || r.completed_at),
      memo: r.memo || "",
    });
  });

  const header = ["VIN","State","Base Status","Update(Y/N)","Update By","Update Time(KST)","DTC(Y/N)","DTC By","DTC Time(KST)","Memo"];
  const aoa = [header, ...rows.map(x => [
    x.vin, x.state, x.base_status, x.update_done, x.update_by, x.update_at, x.dtc_done, x.dtc_by, x.dtc_at, x.memo
  ])];

  const ws = XLSX.utils.aoa_to_sheet(aoa);

  ws["!cols"] = [
    { wch: 10 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 16 },
    { wch: 24 }, { wch: 10 }, { wch: 16 }, { wch: 24 }, { wch: 30 }
  ];

  // Header style
  const range = XLSX.utils.decode_range(ws["!ref"]);
  for(let C = range.s.c; C <= range.e.c; ++C){
    const addr = XLSX.utils.encode_cell({r:0, c:C});
    if(ws[addr]){
      ws[addr].s = {
        font: { bold: true, color: { rgb: "FFFFFF" } },
        fill: { fgColor: { rgb: "111111" } },
        alignment: { horizontal: "center", vertical: "center" }
      };
    }
  }

  const colorByState = {
    "Checked": "C6EFCE",
    "Updated": "D9E1F2",
    "In progress": "FFF2CC",
    "Not started": "F2F2F2",
    "Other": "FCE4D6"
  };

  for(let R = 1; R <= range.e.r; ++R){
    const stateAddr = XLSX.utils.encode_cell({r:R, c:1}); // State col (B)
    const stateVal = ws[stateAddr]?.v;
    const fillColor = colorByState[stateVal];
    if(fillColor){
      for(let C = range.s.c; C <= range.e.c; ++C){
        const addr = XLSX.utils.encode_cell({r:R, c:C});
        if(ws[addr]){
          ws[addr].s = ws[addr].s || {};
          ws[addr].s.fill = { fgColor: { rgb: fillColor } };
        }
      }
    }
  }

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Checklist");

  const stamp = new Date().toISOString().slice(0,19).replaceAll(":","-");
  XLSX.writeFile(wb, `checklist_en_${stamp}.xlsx`);
};

$("search").oninput = render;

// ---------- TABS ----------
function setActiveTabs(newTab){
  tab = newTab;
  document.querySelectorAll("#topTabs button, #bottomTabs button").forEach(btn=>{
    btn.classList.toggle("active", btn.dataset.tab === newTab);
  });
  render();
}

document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll('#topTabs button, #bottomTabs button').forEach(btn => {
    btn.onclick = () => setActiveTabs(btn.dataset.tab);
  });
  mustNick();
  load();
});
</script>

  <!-- ✅ Bottom: only My work / Recent -->
  <div class="bottomBar">
    <div class="bottomInner tabs" id="bottomTabs">
      <button data-tab="mine">My work</button>
      <button data-tab="recent">Recent</button>
    </div>
  </div>

</body>
</html>
