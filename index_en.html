<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>QV CR RADAR VIN LIST</title>
  <style>
    body{font-family:system-ui,-apple-system;margin:18px;line-height:1.35}
    .box{border:1px solid #ddd;border-radius:14px;padding:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,button,textarea{border:1px solid #ccc;border-radius:12px;padding:10px;font-size:14px}
    button{background:#f6f6f6}
    button:disabled{opacity:.55}
    .pill{border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-size:13px}
    .list{margin-top:14px;display:flex;flex-direction:column;gap:10px}
    .card{border:1px solid #e3e3e3;border-radius:16px;padding:12px}
    .vin{font-size:26px;font-weight:800}
    .muted{color:#666;font-size:13px}
    .tabs button{border-radius:999px;padding:8px 12px}
    .tabs button.active{background:#111;color:#fff;border-color:#111}
    .right{margin-left:auto}

    /* ✅ Bottom fixed tab bar */
    #bottomTabs{display:flex;width:100%;gap:8px}
    #bottomTabs button{
      flex:1;
      text-align:center;
      white-space:nowrap;
    }
    .bottomBar{
      position:fixed;
      left:0; right:0; bottom:0;
      background:#fff;
      border-top:1px solid #ddd;
      padding:10px 12px;
      z-index:9999;
    }
    .bottomInner{
      max-width:980px;
      margin:0 auto;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    body{padding-bottom:86px;} /* prevent overlap by bottom bar */

    @media (max-width: 520px) {
      .summaryRow{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
      .summaryRow #search{width:100% !important;box-sizing:border-box}
      .summaryPct{width:100%}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
</head>
<body>
  <h2>QV CR RADAR VIN LIST</h2>

  <div class="box">
    <div class="row" style="justify-content:space-between">
      <div>User: <b id="nickLabel">(not set)</b></div>
      <div class="row">
        <button id="nickBtn">Change nickname</button>
        <button id="downloadBtn">Download Excel (XLSX)</button>
      </div>
    </div>

    <div class="row summaryRow" style="margin-top:10px">
      <input id="search" placeholder="Search VIN (last 4 digits)" inputmode="numeric" style="width:210px"/>
      <span class="pill" id="cntTotal">Total -</span>
      <span class="pill" id="cntDtc">DTC check -</span>
      <span class="pill" id="cntUpd">Update completed -</span>
      <span class="pill" id="cntRemain">Remaining -</span>

<div class="summaryPct" style="margin-top:10px;width:100%">
  <div class="muted" style="margin-bottom:6px">
    Update Completion Rate: <b id="pctUpdText">-</b>
  </div>
  <div style="height:12px;border:1px solid #ddd;border-radius:999px;overflow:hidden;background:#eee">
    <div id="updBar" style="height:100%;width:0%;background:linear-gradient(90deg,#4f8cff,#2563eb);transition:width .25s ease"></div>
  </div>

  <div style="height:10px"></div>

  <div class="muted" style="margin-bottom:6px">
    DTC Check Rate (Final): <b id="pctText">-</b>
  </div>
  <div style="height:12px;border:1px solid #ddd;border-radius:999px;overflow:hidden;background:#eee">
    <div id="pctBar" style="height:100%;width:0%;background:linear-gradient(90deg,#4caf50,#2e7d32);transition:width .25s ease"></div>
  </div>
</div>


      <span class="muted" id="saving"></span>
      <span class="right muted" id="rt"></span>
    </div>

    <div class="row tabs" style="margin-top:10px" id="topTabs">
      <button data-tab="all" class="active">All</button>
      <button data-tab="In progress">In progress</button>
      <button data-tab="DTC check">DTC check</button>
      <button data-tab="Update completed">Update completed</button>
      <button data-tab="Other">Other</button>
      <button data-tab="remain">Not started</button>
      <button data-tab="mine">My work</button>
      <button data-tab="recent">Recent changes</button>
    </div>
  </div>

  <div class="list" id="list"></div>

<script>
/* ======= CONFIG (required) ======= */
const SUPABASE_URL = "https://gpdtgrbiyrgekjtgxpgf.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdwZHRncmJpeXJnZWtqdGd4cGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1ODI3ODAsImV4cCI6MjA4NTE1ODc4MH0.tLZb3obtmHgWMTiKf4xhbsiOqmg80o2MPibQhB5Ywco";
const TABLE_NAME = "checklist_en";
/* =============================== */

let NICK = localStorage.getItem("checklist_nick") || "";
let tab = "all";
let items = [];
let saving = false;

const $ = (id)=>document.getElementById(id);

function mustNick(){
  while(!NICK){
    const n = prompt("Enter your nickname (e.g., ShinYoung / Hong Gil-dong)");
    if(!n) continue;
    NICK = n.trim();
    localStorage.setItem("checklist_nick", NICK);
  }
  $("nickLabel").innerText = NICK;
}
$("nickBtn").onclick = ()=>{
  NICK = "";
  localStorage.removeItem("checklist_nick");
  mustNick();
};

function headers(preferReturn=true){
  const h = {
    "apikey": SUPABASE_ANON_KEY,
    "Authorization": "Bearer " + SUPABASE_ANON_KEY,
    "Content-Type": "application/json",
  };
  if(preferReturn) h["Prefer"] = "return=representation";
  return h;
}

function setSaving(v){
  saving=v;
  $("saving").innerText = v ? "Saving..." : "";
  document.querySelectorAll("button").forEach(b=>b.disabled = v);
  $("nickBtn").disabled = false;
}

/* Normalize status values:
   - Accept legacy KR values too (in case old data is copied)
   - Store/display English status strings only
*/
const STATUS = {
  NOT_STARTED: "Not started",
  IN_PROGRESS: "In progress",
  UPDATE_DONE: "Update completed",
  DTC_DONE: "DTC check",
  OTHER: "Other",
};

function normStatus(s){
  s = (s || "").toString().trim();

  // Legacy / empty => Not started
  if (s === "" || s === "잔여" || s === "남음" || s === "remain" || s === "미완" || s === "미완료") return STATUS.NOT_STARTED;

  // Legacy KR -> EN
  if (s === "작업중") return STATUS.IN_PROGRESS;
  if (s === "완료") return STATUS.DTC_DONE;              // legacy "완료" treated as final DTC check
  if (s === "업데이트 완료") return STATUS.UPDATE_DONE;   // if you used this before
  if (s === "기타") return STATUS.OTHER;

  // Already English / custom
  if (s === STATUS.NOT_STARTED) return STATUS.NOT_STARTED;
  if (s === STATUS.IN_PROGRESS) return STATUS.IN_PROGRESS;
  if (s === STATUS.UPDATE_DONE) return STATUS.UPDATE_DONE;
  if (s === STATUS.DTC_DONE) return STATUS.DTC_DONE;
  if (s === STATUS.OTHER) return STATUS.OTHER;

  // Unknown => Other
  return STATUS.OTHER;
}

function formatKST(iso){
  if(!iso) return "-";
  const d = new Date(iso);
  return new Intl.DateTimeFormat("en-GB", {
    timeZone: "Asia/Seoul",
    year: "numeric", month: "2-digit", day: "2-digit",
    hour: "2-digit", minute: "2-digit", second: "2-digit",
    hour12: false
  }).format(d);
}

async function load(){
  const url = `${SUPABASE_URL}/rest/v1/${TABLE_NAME}?select=*`;
  const r = await fetch(url, {headers: headers(true)});
  if(!r.ok){
    $("rt").innerText = "Load failed";
    console.log(await r.text());
    return;
  }
  items = await r.json();
  $("rt").innerText = "Connected ✅";
  render();
}

function render(){
  const q = $("search").value.trim();
  let view = items.map(x=>({...x, status:normStatus(x.status)}));

  if(tab !== "all"){
    if(tab === "remain"){
      view = view.filter(x => normStatus(x.status) === STATUS.NOT_STARTED);
    } else if(tab === "mine"){
      view = view.filter(x =>
        (x.updated_by || "") === NICK || (x.completed_by || "") === NICK
      );
    } else if(tab === "recent"){
      const since = Date.now() - 30*60*1000;
      view = view.filter(x =>
        x.updated_at && (new Date(x.updated_at).getTime() >= since)
      );
      view.sort((a, b) =>
        new Date(b.updated_at).getTime() - new Date(a.updated_at).getTime()
      );
    } else {
      // IN_PROGRESS / UPDATE_DONE / DTC_DONE / OTHER
      view = view.filter(x => normStatus(x.status) === tab);
    }
  }

  if(q) view = view.filter(x=>String(x.vin).includes(q));

  // Default order: Not started -> In progress -> Update completed -> DTC check -> Other
  const order = {
    [STATUS.NOT_STARTED]: 1,
    [STATUS.IN_PROGRESS]: 2,
    [STATUS.UPDATE_DONE]: 3,
    [STATUS.DTC_DONE]: 4,
    [STATUS.OTHER]: 5,
  };
  view.sort((a,b)=>
    (order[a.status]||9)-(order[b.status]||9) ||
    String(a.vin).localeCompare(String(b.vin))
  );

  const total = items.length;
  const dtcDone = items.filter(x=>normStatus(x.status)===STATUS.DTC_DONE).length;
  const updDone = items.filter(x=>normStatus(x.status)===STATUS.UPDATE_DONE).length;

  $("cntTotal").innerText = `Total ${total}`;
  $("cntDtc").innerText   = `DTC check ${dtcDone}`;
  $("cntUpd").innerText   = `Update completed ${updDone}`;
  $("cntRemain").innerText= `Remaining ${Math.max(0, total - dtcDone)}`;

  const pctDtc = total ? Math.round((dtcDone / total) * 100) : 0;
  const pctUpd = total ? Math.round((updDone / total) * 100) : 0;

$("pctText").innerText = pctDtc + "%";
$("pctBar").style.width = pctDtc + "%";

$("pctUpdText").innerText = pctUpd + "%";
$("updBar").style.width = pctUpd + "%";

  const box = $("list");
  box.innerHTML="";

  view.forEach(it=>{
    const d = document.createElement("div");
    d.className="card";

    const completedText = formatKST(it.completed_at);
    const completedBy = it.completed_by || "-";
    const updatedText = formatKST(it.updated_at);
    const updatedBy = it.updated_by || "-";

    d.innerHTML = `
      <div class="vin">${it.vin}</div>
      <div class="muted">Status: <b>${normStatus(it.status)}</b></div>
      <div class="muted">DTC checked: ${completedText} · ${completedBy}</div>
      <div class="muted">Last updated: ${updatedText} · ${updatedBy}</div>
      <div class="muted">Memo: ${it.memo ? it.memo : "-"}</div>
      <div class="row" style="margin-top:10px">
        <button onclick="setStatus('${it.id}','${STATUS.NOT_STARTED}')">${STATUS.NOT_STARTED}</button>
        <button onclick="setStatus('${it.id}','${STATUS.IN_PROGRESS}')">${STATUS.IN_PROGRESS}</button>
        <button onclick="setStatus('${it.id}','${STATUS.DTC_DONE}')">${STATUS.DTC_DONE}</button>
        <button onclick="setStatus('${it.id}','${STATUS.UPDATE_DONE}')">${STATUS.UPDATE_DONE}</button>
        <button onclick="setStatus('${it.id}','${STATUS.OTHER}')">${STATUS.OTHER}</button>
      </div>
    `;
    box.appendChild(d);
  });
}

async function setStatus(id, status){
  mustNick();
  setSaving(true);

  let memoValue = null;

  // Prompt memo when "Other"
  if(status === STATUS.OTHER){
    const cur = items.find(x => x.id === id);
    const prevMemo = cur?.memo || "";
    const m = prompt("Enter memo (Other)", prevMemo);
    if(m === null){
      setSaving(false);
      return;
    }
    memoValue = m.trim();
  }

  const payload = {
    status,
    updated_by: NICK,
    updated_at: new Date().toISOString()
  };
  if(status === STATUS.OTHER){
    payload.memo = memoValue;
  }

  // ✅ Final completion is only when "DTC check"
  if(status === STATUS.DTC_DONE){
    payload.completed_by = NICK;
    payload.completed_at = new Date().toISOString();
  } else {
    payload.completed_by = null;
    payload.completed_at = null;
  }

  const url = `${SUPABASE_URL}/rest/v1/${TABLE_NAME}?id=eq.${encodeURIComponent(id)}`;
  const r = await fetch(url, {method:"PATCH", headers: headers(true), body: JSON.stringify(payload)});
  setSaving(false);

  if(!r.ok){
    alert("Save failed. Check console / permissions / RLS.");
    console.log(await r.text());
    return;
  }
  await load();
}

$("downloadBtn").onclick = ()=>{
  // Build rows (KST string times)
  const rows = items.map(r => ({
    vin: r.vin,
    status: normStatus(r.status),
    memo: r.memo || "",
    updated_by: r.updated_by || "",
    updated_at: formatKST(r.updated_at),
    completed_by: r.completed_by || "",
    completed_at: formatKST(r.completed_at),
  }));

  const header = ["VIN","Status","Memo","Last Updated By","Last Updated Time (KST)","DTC Checked By","DTC Checked Time (KST)"];
  const aoa = [header, ...rows.map(x => [
    x.vin, x.status, x.memo, x.updated_by, x.updated_at, x.completed_by, x.completed_at
  ])];

  const ws = XLSX.utils.aoa_to_sheet(aoa);

  ws["!cols"] = [
    { wch: 10 }, { wch: 18 }, { wch: 30 }, { wch: 16 },
    { wch: 24 }, { wch: 16 }, { wch: 24 }
  ];

  // Header style
  const range = XLSX.utils.decode_range(ws["!ref"]);
  for(let C = range.s.c; C <= range.e.c; ++C){
    const addr = XLSX.utils.encode_cell({r:0, c:C});
    if(ws[addr]){
      ws[addr].s = {
        font: { bold: true, color: { rgb: "FFFFFF" } },
        fill: { fgColor: { rgb: "111111" } },
        alignment: { horizontal: "center", vertical: "center" }
      };
    }
  }

  // Row fill by status
  const colorByStatus = {
    [STATUS.DTC_DONE]: "C6EFCE",       // green
    [STATUS.UPDATE_DONE]: "D9E1F2",    // light blue
    [STATUS.IN_PROGRESS]: "FFF2CC",    // light yellow
    [STATUS.NOT_STARTED]: "F2F2F2",    // light gray
    [STATUS.OTHER]: "FCE4D6"           // light orange
  };

  for(let R = 1; R <= range.e.r; ++R){
    const sAddr = XLSX.utils.encode_cell({r:R, c:1}); // Status col (B)
    const statusVal = ws[sAddr]?.v;
    const fillColor = colorByStatus[statusVal];
    if(fillColor){
      for(let C = range.s.c; C <= range.e.c; ++C){
        const addr = XLSX.utils.encode_cell({r:R, c:C});
        if(ws[addr]){
          ws[addr].s = ws[addr].s || {};
          ws[addr].s.fill = { fgColor: { rgb: fillColor } };
        }
      }
    }
  }

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Checklist");

  const stamp = new Date().toISOString().slice(0,19).replaceAll(":","-");
  XLSX.writeFile(wb, `checklist_en_${stamp}.xlsx`);
};

$("search").oninput = render;

function setActiveTabs(newTab){
  tab = newTab;

  document.querySelectorAll("#topTabs button, #bottomTabs button").forEach(btn=>{
    btn.classList.toggle("active", btn.dataset.tab === newTab);
  });

  render();
}

document.addEventListener("DOMContentLoaded", () => {
  // Bind both top & bottom tab clicks
  document.querySelectorAll('#topTabs button, #bottomTabs button').forEach(btn => {
    btn.onclick = () => setActiveTabs(btn.dataset.tab);
  });

  mustNick();
  load();
});
</script>

  <div class="bottomBar">
    <div class="bottomInner tabs" id="bottomTabs">
      <button data-tab="all" class="active">All</button>
      <button data-tab="In progress">In progress</button>
      <button data-tab="DTC check">DTC check</button>
      <button data-tab="Update completed">Update completed</button>
      <button data-tab="Other">Other</button>
      <button data-tab="remain">Not started</button>
      <button data-tab="mine">My work</button>
      <button data-tab="recent">Recent changes</button>
    </div>
  </div>
</body>
</html>
