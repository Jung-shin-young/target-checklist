<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>ëœë¤ ë“œë¡­ ì„œë°”ì´ë²Œ (Plinko)</title>
  <style>
    :root { --r: 16px; }
    body{
      margin:0; background:#0b0f14; color:#e9eef6;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px;}
    .card{
      background:#111826;border:1px solid #223049;border-radius:var(--r);
      padding:12px; box-shadow:0 8px 22px rgba(0,0,0,.35);
    }
    h1{font-size:18px;margin:0 0 8px;}
    .muted{color:#a9b6cc;font-size:13px;line-height:1.35}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px}
    input,textarea,select,button{
      border:1px solid #2a3a57;background:#0e1522;color:#e9eef6;
      border-radius:12px;padding:10px 12px;font-size:14px;outline:none;
    }
    textarea{width:100%;resize:vertical;min-height:90px}
    button{cursor:pointer;background:#1a2a46}
    button.primary{background:#2d5bff;border-color:#2d5bff}
    button.danger{background:#ff3b3b;border-color:#ff3b3b;color:#fff}
    button:disabled{opacity:.55;cursor:not-allowed}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid #2a3a57;padding:8px 10px;border-radius:999px;background:#0e1522}
    .sep{height:1px;background:#223049;margin:10px 0}
    .center{text-align:center}
    .big{font-size:22px;font-weight:800}

    /* âœ… í´ë¦­ ì”¹í˜ ë°©ì§€: ë²„íŠ¼ì´ ìº”ë²„ìŠ¤ë³´ë‹¤ ë¬´ì¡°ê±´ ìœ„ */
    .controls{position:relative; z-index:10;}
    canvas{position:relative; z-index:1;}

    canvas{
      width:100%; height:auto; display:block;
      border-radius:14px; border:1px solid #223049; background:#0e1522;
      touch-action: manipulation;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ğŸ¯ ëœë¤ ë“œë¡­ ì„œë°”ì´ë²Œ (Plinko)</h1>
    <div class="muted">
      ì´ë¦„ ì…ë ¥ â†’ <b>ë³´ë“œ ì¤€ë¹„</b> â†’ <b>DROP</b><br/>
      ê³µì´ í•€ì— íŠ•ê¸°ë©° ë‚´ë ¤ì™€ì„œ ë§ˆì§€ë§‰ì— ë”± í•œ ì¹¸ì— ë–¨ì–´ì§ â†’ ê²°ê³¼ í™•ì •.
    </div>

    <div class="row">
      <textarea id="names" placeholder="ì´ë¦„ì„ ì¤„ë°”ê¿ˆìœ¼ë¡œ ì…ë ¥ (ìµœëŒ€ 10ëª…)
ì˜ˆ:
ì² ìˆ˜
ì˜í¬
ë¯¼ìˆ˜"></textarea>
    </div>

    <div class="row controls">
      <span class="pill">ê³µ ê°œìˆ˜
        <select id="ballCount">
          <option value="1" selected>1ê°œ (ê¸°ë³¸)</option>
          <option value="2">2ê°œ (ë” ë°•ì§„ê°)</option>
          <option value="3">3ê°œ (ë‚œì¥íŒ)</option>
        </select>
      </span>

      <span class="pill">í•€ ë°€ë„
        <select id="pinDensity">
          <option value="low">ë‚®ìŒ</option>
          <option value="mid" selected>ë³´í†µ</option>
          <option value="high">ë†’ìŒ</option>
        </select>
      </span>

      <span class="pill">ê²°ê³¼ ê·œì¹™
        <select id="rule">
          <option value="lose" selected>ë§ì€ ì‚¬ëŒ íŒ¨ë°°</option>
          <option value="win">ë§ì€ ì‚¬ëŒ ë‹¹ì²¨</option>
        </select>
      </span>
    </div>

    <div class="row controls">
      <button class="primary" id="prepBtn">ë³´ë“œ ì¤€ë¹„</button>
      <button class="primary" id="dropBtn" disabled>DROP ğŸ±</button>
      <button id="shakeBtn" disabled>í”ë“¤ê¸°(ë‚œìˆ˜)</button>
      <button class="danger" id="resetBtn">ë¦¬ì…‹</button>
      <span class="muted" id="msg"></span>
    </div>

    <div class="sep"></div>

    <canvas id="cv" width="900" height="1200"></canvas>

    <div class="sep"></div>
    <div class="center">
      <div class="muted">ê²°ê³¼</div>
      <div class="big" id="result">-</div>
    </div>
  </div>
</div>

<script>
window.addEventListener("DOMContentLoaded", () => {
  const $ = (id) => document.getElementById(id);
  const msgEl = $("msg");
  const resultEl = $("result");

  // âœ… ì—ëŸ¬ê°€ ë‚˜ë©´ í™”ë©´ì— ë°”ë¡œ í‘œì‹œ
  window.onerror = function (m, s, line, col) {
    msgEl.textContent = `JS ì˜¤ë¥˜: ${m} (line ${line}:${col})`;
  };

  // crypto random
  function rand01(){
    const u = new Uint32Array(1);
    crypto.getRandomValues(u);
    return u[0] / 0xFFFFFFFF;
  }
  function randInt(min, maxInclusive){
    return min + Math.floor(rand01() * (maxInclusive - min + 1));
  }
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = randInt(0,i);
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }

  function setMsg(t=""){ msgEl.textContent = t; }
  function setResult(t="-"){ resultEl.textContent = t; }

  const cv = $("cv");
  const ctx = cv.getContext("2d");

  const W = cv.width, H = cv.height;
  const topMargin = 90;
  const side = 40;
  const bottomH = 190;

  // state
  let ready = false;
  let running = false;

  let names = [];
  let slots = [];
  let pins = [];
  let balls = [];

  // physics params
  const gravity = 0.24;
  const restitution = 0.78;
  const friction = 0.998;
  const air = 0.999;
  let shakeVX = 0;

  function parseNames(){
    const raw = $("names").value.split("\n").map(s=>s.trim()).filter(Boolean);
    const seen = new Set();
    const out = [];
    for(const n of raw){
      if(!seen.has(n)){ seen.add(n); out.push(n); }
    }
    return out.slice(0,10);
  }

  function roundRect(ctx, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  function drawNamePill(cx, cy, text){
    ctx.save();
    ctx.font = "24px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    const padX = 18;
    const w = ctx.measureText(text).width + padX*2;
    const h = 44;

    ctx.fillStyle = "#0e1522";
    ctx.strokeStyle = "#2a3a57";
    ctx.lineWidth = 2;
    roundRect(ctx, cx - w/2, cy - h/2, w, h, 999);
    ctx.fill();
    ctx.stroke();

    ctx.fillStyle = "#e9eef6";
    ctx.fillText(text, cx, cy+1);
    ctx.restore();
  }

  function buildBoard(){
    names = parseNames();
    if(names.length < 3){
      ready = false;
      $("dropBtn").disabled = true;
      $("shakeBtn").disabled = true;
      setMsg("ìµœì†Œ 3ëª…ë¶€í„° ê°€ëŠ¥!");
      draw();
      return;
    }

    setMsg(`ë³´ë“œ ì¤€ë¹„ ì™„ë£Œ: ${names.length}ëª…`);
    setResult("-");

    // slots
    slots = [];
    const n = names.length;
    const slotW = (W - side*2) / n;
    for(let i=0;i<n;i++){
      slots.push({
        i,
        name: names[i],
        x0: side + i*slotW,
        x1: side + (i+1)*slotW
      });
    }

    // pins
    pins = [];
    const density = $("pinDensity").value;
    const gapY = density==="low" ? 98 : density==="high" ? 62 : 78;
    const gapX = density==="low" ? 98 : density==="high" ? 62 : 78;
    const pinR = density==="high" ? 10 : density==="low" ? 12 : 11;

    const startY = topMargin + 70;
    const endY = H - bottomH - 70;

    let row = 0;
    for(let y = startY; y <= endY; y += gapY){
      const offset = (row % 2) ? gapX/2 : 0;
      for(let x = side + 50 + offset; x <= W - side - 50; x += gapX){
        const jx = (rand01()-0.5) * 10;
        const jy = (rand01()-0.5) * 6;
        pins.push({ x: x + jx, y: y + jy, r: pinR });
      }
      row++;
    }

    balls = [];
    ready = true;
    running = false;

    // âœ… DROP ë²„íŠ¼ í™œì„±í™” í™•ì‹¤í•˜ê²Œ
    $("dropBtn").disabled = false;
    $("shakeBtn").disabled = false;
    $("dropBtn").textContent = "DROP ğŸ±";

    draw();
  }

  function applyShake(){
    if(!ready) return;
    shakeVX = (rand01() < 0.5 ? -1 : 1) * (2.2 + rand01()*2.2);
    setMsg("ë³´ë“œ í”ë“¤ë¦¼! ã…‹ã…‹");
    setTimeout(()=>{ shakeVX = 0; setMsg(""); }, 500);
  }

  function spawnBalls(){
    if(!ready){ setMsg("ë¨¼ì € ë³´ë“œ ì¤€ë¹„!"); return; }
    if(running){ setMsg("ì§„í–‰ì¤‘! ì ê¹ë§Œ"); return; }

    setMsg("");
    setResult("-");
    running = true;
    balls = [];

    const k = Number($("ballCount").value);
    for(let i=0;i<k;i++){
      const r = 16;
      const x = W/2 + (i-(k-1)/2)*36 + (rand01()-0.5)*18;
      const y = topMargin;
      balls.push({
        x, y, r,
        vx: (rand01()-0.5)*2.2,
        vy: 0,
        done: false,
        landedSlot: null
      });
    }
  }

  function circleCollision(ball, pin){
    const dx = ball.x - pin.x;
    const dy = ball.y - pin.y;
    const dist = Math.hypot(dx, dy);
    const minDist = ball.r + pin.r;
    if(dist < minDist && dist > 0.0001){
      const nx = dx / dist;
      const ny = dy / dist;
      const overlap = (minDist - dist);

      ball.x += nx * overlap;
      ball.y += ny * overlap;

      const vn = ball.vx*nx + ball.vy*ny;
      if(vn < 0){
        ball.vx -= (1 + restitution) * vn * nx;
        ball.vy -= (1 + restitution) * vn * ny;
      }

      // tiny randomness
      ball.vx += (rand01()-0.5)*0.25;
      ball.vy += (rand01()-0.5)*0.12;
    }
  }

  function wallCollision(ball){
    if(ball.x - ball.r < side){
      ball.x = side + ball.r;
      ball.vx = Math.abs(ball.vx) * restitution;
    }
    if(ball.x + ball.r > W - side){
      ball.x = W - side - ball.r;
      ball.vx = -Math.abs(ball.vx) * restitution;
    }
    if(ball.y - ball.r < 20){
      ball.y = 20 + ball.r;
      ball.vy = Math.abs(ball.vy) * restitution;
    }
  }

  function checkLanding(ball){
    const yFloor = H - bottomH + 20;
    if(ball.y + ball.r >= yFloor){
      const s = slots.find(sl => ball.x >= sl.x0 && ball.x < sl.x1) || slots[slots.length-1];
      ball.done = true;
      ball.landedSlot = s;
      ball.y = yFloor - ball.r;
      ball.vx = 0; ball.vy = 0;
    }
  }

  function finalizeResult(){
    if(!balls.length) return;
    const picked = balls[randInt(0, balls.length-1)].landedSlot;
    const rule = $("rule").value;
    const text = (rule === "lose")
      ? `ğŸ’¥ ${picked.name} íŒ¨ë°°!`
      : `ğŸ‰ ${picked.name} ë‹¹ì²¨!`;
    setResult(text);

    // mini flash
    let t=0;
    const id = setInterval(()=>{
      t++;
      ctx.save();
      ctx.globalAlpha = 0.08;
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0,0,W,H);
      ctx.restore();
      if(t>=6) clearInterval(id);
    }, 60);
  }

  function draw(){
    ctx.clearRect(0,0,W,H);

    // base
    ctx.save();
    ctx.fillStyle = "#0e1522";
    ctx.fillRect(0,0,W,H);
    ctx.restore();

    // frame
    ctx.save();
    ctx.strokeStyle = "#223049";
    ctx.lineWidth = 4;
    roundRect(ctx, side-10, 20, W - (side-10)*2, H-40, 18);
    ctx.stroke();
    ctx.restore();

    // top funnel
    ctx.save();
    ctx.strokeStyle = "#2a3a57";
    ctx.lineWidth = 5;
    ctx.beginPath();
    ctx.moveTo(W/2 - 140, topMargin);
    ctx.lineTo(W/2 - 40, 20);
    ctx.moveTo(W/2 + 140, topMargin);
    ctx.lineTo(W/2 + 40, 20);
    ctx.stroke();
    ctx.restore();

    // pins
    ctx.save();
    ctx.fillStyle = "#cfe3ff";
    for(const p of pins){
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.restore();

    // bottom slots area
    const yTop = H - bottomH;
    ctx.save();
    ctx.fillStyle = "#0b0f14";
    ctx.fillRect(0, yTop, W, bottomH);
    ctx.restore();

    // slot dividers + names
    ctx.save();
    ctx.strokeStyle = "#223049";
    ctx.lineWidth = 3;

    for(const sl of slots){
      ctx.beginPath();
      ctx.moveTo(sl.x0, yTop);
      ctx.lineTo(sl.x0, H-20);
      ctx.stroke();

      const cx = (sl.x0 + sl.x1) / 2;
      const cy = yTop + 95;
      drawNamePill(cx, cy, sl.name);
    }
    if(slots.length){
      const last = slots[slots.length-1];
      ctx.beginPath();
      ctx.moveTo(last.x1, yTop);
      ctx.lineTo(last.x1, H-20);
      ctx.stroke();
    }
    ctx.restore();

    // balls
    ctx.save();
    for(const b of balls){
      ctx.beginPath();
      ctx.fillStyle = b.done ? "#2d5bff" : "#ffffff";
      ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
      ctx.fill();

      ctx.globalAlpha = 0.25;
      ctx.beginPath();
      ctx.fillStyle = "#ffffff";
      ctx.arc(b.x - 6, b.y - 7, b.r*0.55, 0, Math.PI*2);
      ctx.fill();
      ctx.globalAlpha = 1;
    }
    ctx.restore();

    // hint overlay
    if(!ready){
      ctx.save();
      ctx.fillStyle = "rgba(0,0,0,.35)";
      ctx.fillRect(0,0,W,H);
      ctx.fillStyle = "#e9eef6";
      ctx.font = "34px system-ui";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("ì´ë¦„ ì…ë ¥ â†’ ë³´ë“œ ì¤€ë¹„", W/2, H/2);
      ctx.restore();
    } else if(!running && balls.length===0){
      ctx.save();
      ctx.fillStyle = "#a9b6cc";
      ctx.font = "26px system-ui";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("DROPì„ ëˆŒëŸ¬ ì‹œì‘!", W/2, topMargin + 40);
      ctx.restore();
    }
  }

  function loop(){
    if(running){
      for(const b of balls){
        if(b.done) continue;

        b.vy += gravity;
        b.vx += shakeVX * 0.03;

        b.x += b.vx;
        b.y += b.vy;

        b.vx *= friction;
        b.vy *= air;

        wallCollision(b);

        for(const p of pins){
          circleCollision(b,p);
        }

        checkLanding(b);
      }

      if(balls.length && balls.every(b => b.done)){
        running = false;
        finalizeResult();
      }
    }

    draw();
    requestAnimationFrame(loop);
  }

  // handlers
  $("prepBtn").addEventListener("click", buildBoard);
  $("dropBtn").addEventListener("click", spawnBalls);
  $("shakeBtn").addEventListener("click", applyShake);
  $("resetBtn").addEventListener("click", () => {
    ready = false;
    running = false;
    names = [];
    slots = [];
    pins = [];
    balls = [];
    shakeVX = 0;
    $("dropBtn").disabled = true;
    $("shakeBtn").disabled = true;
    setMsg("");
    setResult("-");
    draw();
  });

  // first draw + start loop
  draw();
  requestAnimationFrame(loop);
});
</script>
</body>
</html>
