<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ëœë¤ ì œë¡œê²Œì„ ë£° ìƒì„±ê¸°</title>
  <style>
    :root{
      --bg1:#070A16;
      --bg2:#071B2E;
      --card: rgba(255,255,255,.07);
      --stroke: rgba(255,255,255,.12);
      --text: #EEF3FF;
      --muted: rgba(238,243,255,.72);
      --good:#40f99b;
      --bad:#ff4d6d;
      --blue:#4ea3ff;
      --purple:#b388ff;
      --glow: 0 0 18px rgba(78,163,255,.25), 0 0 40px rgba(179,136,255,.14);
      --r: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
      background:
        radial-gradient(1100px 700px at 15% 15%, rgba(179,136,255,.26), transparent 60%),
        radial-gradient(900px 650px at 90% 20%, rgba(78,163,255,.22), transparent 58%),
        radial-gradient(900px 700px at 40% 95%, rgba(255,77,109,.12), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      -webkit-tap-highlight-color: transparent;
    }
    .wrap{ max-width: 980px; margin: 0 auto; padding: 14px; }
    .top{
      border:1px solid var(--stroke);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: var(--glow);
      padding: 14px;
      backdrop-filter: blur(10px);
    }
    h1{ margin:0; font-size:18px; letter-spacing:.4px; }
    .sub{ margin-top:6px; color:var(--muted); font-size:13px; line-height:1.35; }
    .grid{ display:grid; grid-template-columns: 1fr; gap: 12px; margin-top: 12px; }
    @media (min-width: 920px){ .grid{ grid-template-columns: 1.05fr .95fr; } }

    .card{
      border:1px solid var(--stroke);
      border-radius: var(--r);
      background: var(--card);
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      padding: 12px;
      backdrop-filter: blur(10px);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    textarea, select, button, input{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.26);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
    }
    textarea{ width:100%; min-height: 90px; resize: vertical; }
    button{ cursor:pointer; transition: transform .05s ease, filter .15s ease; }
    button:active{ transform: scale(0.98); }
    button.primary{
      background: linear-gradient(90deg, rgba(78,163,255,.95), rgba(179,136,255,.90));
      border-color: rgba(255,255,255,.14);
      box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset, 0 0 18px rgba(78,163,255,.22);
    }
    button.secondary{
      background: rgba(0,0,0,.18);
      border-color: rgba(255,255,255,.14);
    }
    button.danger{
      background: linear-gradient(90deg, rgba(255,77,109,.95), rgba(255,140,0,.70));
      border-color: rgba(255,255,255,.10);
      box-shadow: 0 0 18px rgba(255,77,109,.18);
    }
    button:disabled{ opacity:.55; cursor:not-allowed; filter: grayscale(.2); }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      font-size: 12px;
    }
    .sep{ height:1px; background: rgba(255,255,255,.10); margin: 10px 0; }
    .big{
      font-size: 30px;
      font-weight: 900;
      letter-spacing: .6px;
      text-shadow: 0 0 14px rgba(78,163,255,.22);
    }
    .timer{
      font-size: 52px;
      font-weight: 950;
      letter-spacing: 1px;
      text-shadow: 0 0 16px rgba(179,136,255,.20);
    }
    .muted{ color: var(--muted); font-size: 13px; }
    .hint{ color: rgba(255,255,255,.65); font-size: 12px; }
    .ruleBox{
      border:1px solid rgba(255,255,255,.14);
      border-radius: 16px;
      padding: 12px;
      background: rgba(0,0,0,.20);
    }
    .ruleTitle{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      font-size: 12px;
      color: var(--muted);
    }
    .ruleList{ margin-top:10px; display:flex; flex-direction:column; gap:8px; }
    .ruleItem{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      display:flex; gap:10px; align-items:flex-start;
    }
    .dot{
      width:10px; height:10px; border-radius:999px; margin-top:5px;
      box-shadow: 0 0 10px rgba(255,255,255,.10);
      flex: 0 0 10px;
    }
    .dot.good{ background: var(--good); box-shadow: 0 0 12px rgba(64,249,155,.25); }
    .dot.bad{ background: var(--bad); box-shadow: 0 0 12px rgba(255,77,109,.25); }
    .dot.blue{ background: var(--blue); box-shadow: 0 0 12px rgba(78,163,255,.25); }
    .dot.purple{ background: var(--purple); box-shadow: 0 0 12px rgba(179,136,255,.25); }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 8px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      color: rgba(238,243,255,.85);
    }
    .center{ text-align:center; }
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.16);
      color: rgba(238,243,255,.92);
      padding: 10px 12px;
      border-radius: 999px;
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      display:none;
      max-width: calc(100vw - 24px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="row" style="justify-content:space-between; align-items:flex-end;">
      <div>
        <h1>ğŸ² ëœë¤ ì œë¡œê²Œì„ ë£° ìƒì„±ê¸°</h1>
        <div class="sub">
          ê²Œì„ ìì²´ëŠ” ë‹¨ìˆœ â€œ0ë¶€í„° ì¹´ìš´íŠ¸â€ì¸ë°, ë§¤ ë¼ìš´ë“œ ë£°ì´ ëœë¤ìœ¼ë¡œ ê¼¬ì—¬ì„œ í„°ì§€ëŠ” ìš©ë„.<br/>
          í° 1ëŒ€ë¡œ ëŒë ¤ê°€ë©°: <span class="kbd">ìƒˆ ë£°</span> â†’ <span class="kbd">3-2-1 ì‹œì‘</span> â†’ ì§„í–‰.
        </div>
      </div>
      <div class="pill">â˜• ì»¤í”¼ë‚´ê¸° / íšŒì‹ê²Œì„ / ì œë¡œê²Œì„ìš©</div>
    </div>
  </div>

  <div class="grid">
    <!-- Left: setup -->
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="muted">1) ì°¸ê°€ì</div>
        <div class="tag">ìµœëŒ€ 10ëª… Â· ìµœì†Œ 3ëª…</div>
      </div>

      <div class="row">
        <textarea id="names" placeholder="ì´ë¦„ì„ ì¤„ë°”ê¿ˆìœ¼ë¡œ ì…ë ¥
ì˜ˆ:
ì² ìˆ˜
ì˜í¬
ë¯¼ìˆ˜"></textarea>
      </div>

      <div class="sep"></div>

      <div class="row" style="justify-content:space-between;">
        <div class="muted">2) ë‚œì´ë„ / ì˜µì…˜</div>
        <div class="tag">ë£°ì´ ë„ˆë¬´ ë¹¡ì„¸ë©´ ë‚œì´ë„ ë‚®ì¶”ê¸°</div>
      </div>

      <div class="row">
        <span class="pill">ë‚œì´ë„
          <select id="level">
            <option value="mild">ìˆœí•œë§›</option>
            <option value="normal" selected>ë³´í†µ</option>
            <option value="hell">ì§€ì˜¥</option>
          </select>
        </span>
        <span class="pill">ë¼ìš´ë“œ ì‹œê°„(ì´ˆ)
          <select id="roundSec">
            <option value="15">15</option>
            <option value="25" selected>25</option>
            <option value="35">35</option>
          </select>
        </span>
        <span class="pill">ë£° ê°œìˆ˜
          <select id="ruleCount">
            <option value="3">3ê°œ</option>
            <option value="4" selected>4ê°œ</option>
            <option value="5">5ê°œ</option>
          </select>
        </span>
      </div>

      <div class="row">
        <span class="pill">ì‚¬ìš´ë“œ(ì„ íƒ)
          <select id="sound">
            <option value="off" selected>OFF</option>
            <option value="on">ON</option>
          </select>
        </span>
        <span class="pill">ì§„ë™(ì„ íƒ)
          <select id="vibe">
            <option value="off" selected>OFF</option>
            <option value="on">ON</option>
          </select>
        </span>
        <span class="pill">ê¸ˆì§€ ìˆ«ì(ì„ íƒ)
          <input id="banNumCustom" inputmode="numeric" placeholder="ì˜ˆ: 4" style="width:110px"/>
        </span>
      </div>

      <div class="sep"></div>

      <div class="row">
        <button class="primary" id="genBtn">ğŸ² ìƒˆ ë£° ìƒì„±</button>
        <button class="secondary" id="startBtn" disabled>â–¶ 3-2-1 ì‹œì‘</button>
        <button class="danger" id="resetBtn">ë¦¬ì…‹</button>
        <span class="muted" id="msg"></span>
      </div>

      <div class="sep"></div>

      <div class="ruleBox">
        <div class="ruleTitle">
          <div>
            <div class="muted">í˜„ì¬ ë£° ì„¸íŠ¸</div>
            <div class="hint">ë¼ìš´ë“œ ì‹œì‘ ì „: ë£° ì½ê³ , ëª¨ë‘ ë™ì˜í•˜ë©´ ì‹œì‘</div>
          </div>
          <div class="tag">Round <span id="roundNo">0</span></div>
        </div>
        <div class="ruleList" id="rules">
          <div class="ruleItem">
            <span class="dot blue"></span>
            <div>ì•„ì§ ë£°ì´ ì—†ì–´ìš”. <b>ìƒˆ ë£° ìƒì„±</b>ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right: play -->
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="muted">3) ì§„í–‰ í™”ë©´</div>
        <div class="tag">í° ëŒë ¤ê°€ë©° ë³´ê¸°</div>
      </div>

      <div class="sep"></div>

      <div class="center">
        <div class="muted">í˜„ì¬ í„´</div>
        <div class="big" id="turnName">-</div>
        <div class="muted" style="margin-top:6px;">ë‚¨ì€ ì‹œê°„</div>
        <div class="timer" id="timeLeft">--</div>
        <div class="muted" id="statusText" style="margin-top:6px;">ë£° ìƒì„± í›„ ì‹œì‘í•˜ì„¸ìš”.</div>
      </div>

      <div class="sep"></div>

      <div class="row">
        <button class="secondary" id="prevBtn" disabled>â† ì´ì „</button>
        <button class="secondary" id="nextBtn" disabled>ë‹¤ìŒ â†’</button>
        <button class="primary" id="failBtn" disabled>ğŸš« ì‹¤ìˆ˜(ë²Œì¹™ì)</button>
      </div>

      <div class="sep"></div>
      <div class="muted">
        íŒ: â€œì‹¤ìˆ˜(ë²Œì¹™ì)â€ ë²„íŠ¼ì€ ì‹¤ì œ íŒì •ì´ ì• ë§¤í•  ë•Œë§Œ ëˆ„ë¥´ê³ , ë³´í†µì€ ë§ë¡œ íŒì •í•˜ë©´ ë¨ ã…‹ã…‹
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
window.addEventListener("DOMContentLoaded", () => {
  const $ = (id)=>document.getElementById(id);
  const msg = $("msg");

  // ======= UX helpers =======
  function setMsg(t=""){ msg.textContent = t; }
  function toast(t){
    const el = $("toast");
    el.textContent = t;
    el.style.display = "block";
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>{ el.style.display="none"; }, 1400);
  }

  // ======= crypto random =======
  function rand01(){
    const u = new Uint32Array(1);
    crypto.getRandomValues(u);
    return u[0] / 0xFFFFFFFF;
  }
  function randInt(min, maxInc){
    return min + Math.floor(rand01() * (maxInc - min + 1));
  }
  function pick(arr){ return arr[randInt(0, arr.length-1)]; }
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = randInt(0,i);
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }

  // ======= optional sound/vibe =======
  let audioCtx = null;
  function beep(freq=520, ms=90, gain=0.05){
    if($("sound").value !== "on") return;
    try{
      audioCtx ||= new (window.AudioContext || window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "sine";
      o.frequency.value = freq;
      g.gain.value = gain;
      o.connect(g); g.connect(audioCtx.destination);
      o.start();
      setTimeout(()=>{ o.stop(); }, ms);
    }catch(e){}
  }
  function vibe(ms=40){
    if($("vibe").value !== "on") return;
    if(navigator.vibrate) navigator.vibrate(ms);
  }

  // ======= parsing =======
  function parseNames(){
    const raw = $("names").value.split("\n").map(s=>s.trim()).filter(Boolean);
    const seen = new Set();
    const out = [];
    for(const n of raw){
      if(!seen.has(n)){ seen.add(n); out.push(n); }
    }
    return out.slice(0,10);
  }

  // ======= rule engine =======
  // We generate a "rule set" that makes zero game chaotic but still playable.
  // Keep it funny, not mean, and not too impossible.
  const baseRules = [
    () => ({ kind:"flow", dot:"blue", text:`ì§„í–‰ ë°©í–¥: ${pick(["ì •ë°©í–¥(ì™¼â†’ì˜¤)", "ì—­ë°©í–¥(ì˜¤â†’ì™¼)"])} ë¡œë§Œ ì§„í–‰` }),
    () => ({ kind:"tempo", dot:"purple", text:`ë¦¬ë“¬ ë£°: ë§¤ ìˆ«ì ë§í•˜ê¸° ì „ì— ${pick(["ì†ë¼‰ 1ë²ˆ", "íƒì 1ë²ˆ í†¡", "ì†ê°€ë½ ìŠ¤ëƒ…(ê°€ëŠ¥í•˜ë©´)", "ê³ ê°œ ë„ë• 1ë²ˆ"])} í•˜ê¸°` }),
    () => ({ kind:"voice", dot:"blue", text:`ë§íˆ¬ ë£°: ${pick(["ì¡´ëŒ“ë§ë§Œ", "ë°˜ë§ë§Œ", "ëì— 'ìš”' ë¶™ì´ê¸°", "ëì— 'ë„¤' ë¶™ì´ê¸°"])} (ì‹¤ìˆ˜í•˜ë©´ OUT)` }),
    () => ({ kind:"silence", dot:"bad", text:`ê¸ˆì§€ì–´: "${pick(["ì•„", "ì–´", "ìŒ", "ì ê¹", "ë¯¸ì•ˆ"])}" ë§í•˜ë©´ OUT` }),
    () => ({ kind:"skip", dot:"purple", text:`ìŠ¤í‚¬ ì¹´ë“œ: ${pick(["í•œ ë²ˆì€ 'íŒ¨ìŠ¤' ê°€ëŠ¥", "í•œ ë²ˆì€ ë‚´ ìˆ«ì 1 ì¦ê°€/ê°ì†Œ ì„ íƒ ê°€ëŠ¥", "í•œ ë²ˆì€ ë‹¤ìŒ ì‚¬ëŒ ìŠ¤í‚µ ê°€ëŠ¥(ëœë¤ìœ¼ë¡œë§Œ)"])} (ë¼ìš´ë“œë‹¹ 1íšŒ)` }),
    () => ({ kind:"swap", dot:"blue", text:`ì§€ëª© ë£°: ${pick(["'7'ì„ ë§í•œ ì‚¬ëŒì€ ë‹¤ìŒ ì‚¬ëŒì„ ëœë¤ ì§€ëª©", "'3'ì„ ë§í•œ ì‚¬ëŒì€ ë°©í–¥ ë°˜ì „", "'0'ì„ ë§í•œ ì‚¬ëŒì€ ë°”ë¡œ ë‹¤ìŒ ì‚¬ëŒì—ê²Œ 'ê³ ë§ˆì›Œ' ê°•ì œ"])} ` }),
  ];

  const spicyRules = [
    () => ({ kind:"banNum", dot:"bad", text:`ê¸ˆì§€ ìˆ«ì: ${pick([4,6,7,8,9])} (ê·¸ ìˆ«ì ë§í•˜ë©´ OUT, ëŒ€ì‹  'ë•¡'ìœ¼ë¡œ ëŒ€ì²´)` , banNum: true }),
    () => ({ kind:"double", dot:"purple", text:`ë³€ì¹™: ${pick(["ì§ìˆ˜ëŠ” ë‘ ë²ˆ ë§í•˜ê³  ë„˜ê¸°ê¸°", "í™€ìˆ˜ëŠ” ì†ì‚­ì´ë“¯ ë§í•˜ê¸°", "ìê¸° ì°¨ë¡€ë§ˆë‹¤ ìˆ«ì +1ì„ í•œ ë²ˆ ë” ë§í•˜ê¸°(ì˜ˆ: 3,4)"])} ` }),
    () => ({ kind:"reverse", dot:"blue", text:`íŠ¸ë¦¬ê±°: ${pick(["ëˆ„êµ°ê°€ ì›ƒìœ¼ë©´ ë°©í–¥ ë°˜ì „", "ëˆ„êµ°ê°€ ë¨¸ë­‡ê±°ë¦¬ë©´ ë‹¤ìŒ ì‚¬ëŒ ìŠ¤í‚µ", "ëˆ„êµ°ê°€ ë°•ìˆ˜ íƒ€ì´ë° í‹€ë¦¬ë©´ 2ì¹¸ ì í”„"])} ` }),
    () => ({ kind:"gesture", dot:"purple", text:`ì œìŠ¤ì²˜: ìˆ«ì ë§í•  ë•Œë§ˆë‹¤ ${pick(["ì†ê°€ë½ìœ¼ë¡œ V", "ì—„ì§€ì²™", "ì–‘ì† ì£¼ë¨¹ ì¥ê¸°", "ê°€ìŠ´ì— ì† ì–¹ê¸°"])} ` }),
  ];

  const hellRules = [
    () => ({ kind:"banNum2", dot:"bad", text:`ê¸ˆì§€ ìˆ«ì 2ê°œ: ${pick([2,3,4,5])} & ${pick([6,7,8,9])} (ë‘˜ ë‹¤ 'ë•¡'ìœ¼ë¡œ ëŒ€ì²´)` , banNum: true }),
    () => ({ kind:"speed", dot:"bad", text:`ì†ë„: ê° í„´ ${pick(["1.2ì´ˆ ì•ˆì—", "1.0ì´ˆ ì•ˆì—", "0.8ì´ˆ ì•ˆì—"])} ë§í•´ì•¼ í•¨ (ë„˜ìœ¼ë©´ OUT)` }),
    () => ({ kind:"chain", dot:"purple", text:`ì—°ì‡„: ${pick(["'5' ë‚˜ì˜¤ë©´ ë‹¤ìŒ ì‚¬ëŒì€ ë°”ë¡œ 2ì¹¸ ì§„í–‰", "10ì˜ ë°°ìˆ˜ ì§ì „ì€ ìˆ¨ ë“¤ì´ì‰¬ê³  ë§í•˜ê¸°", "'1'ì„ ë§í•˜ë©´ ë‹¤ìŒ ì‚¬ëŒì€ ì›ƒìŒ ê¸ˆì§€"])} ` }),
    () => ({ kind:"ruleFlip", dot:"blue", text:`ë£° ë°˜ì „: ë¼ìš´ë“œ ì¤‘ê°„(ë‚¨ì€ ì‹œê°„ ì ˆë°˜)ë¶€í„° ${pick(["ë°©í–¥ì´ ë°˜ëŒ€ë¡œ ë°”ë€œ", "ê¸ˆì§€ì–´ê°€ ë°”ë€œ(ìš´ì˜ì ëœë¤)", "ë°•ìˆ˜ ëŒ€ì‹  íƒì í†¡ìœ¼ë¡œ ë³€ê²½"])} ` }),
  ];

  function uniqueByKind(arr){
    const seen = new Set();
    const out = [];
    for(const r of arr){
      if(seen.has(r.kind)) continue;
      seen.add(r.kind);
      out.push(r);
    }
    return out;
  }

  function generateRuleSet(level, count){
    let pool = [...baseRules];
    if(level === "normal") pool = pool.concat(spicyRules);
    if(level === "hell") pool = pool.concat(spicyRules, hellRules);

    let chosen = [];
    while(chosen.length < count){
      const r = pick(pool)();
      chosen.push(r);
      chosen = uniqueByKind(chosen);
      if(chosen.length > count) chosen = chosen.slice(0, count);
    }

    // apply custom banned number if user typed
    const custom = String($("banNumCustom").value || "").trim();
    if(custom && /^\d+$/.test(custom)){
      // replace any banNum rule or add one at top
      const num = Number(custom);
      const banRule = { kind:"banNumCustom", dot:"bad", text:`ê¸ˆì§€ ìˆ«ì: ${num} (ë§í•˜ë©´ OUT, ëŒ€ì‹  'ë•¡')`, banNum:true, value:num };
      let replaced = false;
      chosen = chosen.map(r => {
        if(!replaced && r.banNum){ replaced=true; return banRule; }
        return r;
      });
      if(!replaced){
        // force include by replacing last rule
        chosen[chosen.length-1] = banRule;
      }
    }

    // Always include a "start/goal" context
    const max = pick([15, 20, 25, 30, 35, 40]);
    const startAt = 0;
    const direction = chosen.find(r=>r.kind==="flow") ? "ë£°ì„ ë”°ë¥´ì„¸ìš”" : "ì •ë°©í–¥";
    return {
      startAt,
      goal: max,
      chosen
    };
  }

  function renderRules(ruleSet, roundNo){
    $("roundNo").textContent = String(roundNo);
    const container = $("rules");
    container.innerHTML = "";

    const header = document.createElement("div");
    header.className = "ruleItem";
    header.innerHTML = `
      <span class="dot good"></span>
      <div>
        <b>ê¸°ë³¸:</b> 0ë¶€í„° ì‹œì‘í•´ì„œ ëª©í‘œ ìˆ«ì <b>${ruleSet.goal}</b>ê¹Œì§€ ì§„í–‰ (ì‹¤ìˆ˜/ìœ„ë°˜ ì‹œ OUT)
        <div class="hint">* ëª©í‘œëŠ” ëœë¤. ë„ˆë¬´ ë¹¡ì„¸ë©´ â€œìˆœí•œë§›â€ìœ¼ë¡œ ë‚´ë ¤.</div>
      </div>
    `;
    container.appendChild(header);

    ruleSet.chosen.forEach(r=>{
      const item = document.createElement("div");
      item.className = "ruleItem";
      item.innerHTML = `<span class="dot ${r.dot}"></span><div>${r.text}</div>`;
      container.appendChild(item);
    });

    const footer = document.createElement("div");
    footer.className = "ruleItem";
    footer.innerHTML = `
      <span class="dot good"></span>
      <div>
        <b>íŒì • íŒ:</b> ì• ë§¤í•˜ë©´ â€œë‹¤ì‹œ í•œ ë²ˆâ€ ê¸°íšŒ 1íšŒ ì£¼ê³ , ë‘ ë²ˆì§¸ ì‹¤ìˆ˜ë©´ OUT (ë¶„ìœ„ê¸°ìš©)
      </div>
    `;
    container.appendChild(footer);
  }

  // ======= game state =======
  let roundNo = 0;
  let ruleSet = null;
  let names = [];
  let turn = 0;
  let running = false;
  let timeLeft = 0;
  let timer = null;

  function updateTurnUI(){
    $("turnName").textContent = names.length ? names[turn] : "-";
  }
  function updateTimeUI(){
    $("timeLeft").textContent = running ? String(timeLeft) : "--";
  }
  function setStatus(t){ $("statusText").textContent = t; }

  function stopTimer(){
    if(timer){ clearInterval(timer); timer=null; }
  }

  function enablePlayButtons(on){
    $("prevBtn").disabled = !on;
    $("nextBtn").disabled = !on;
    $("failBtn").disabled = !on;
  }

  function genRules(){
    names = parseNames();
    if(names.length < 3){
      setMsg("ìµœì†Œ 3ëª…ë¶€í„° ê°€ëŠ¥!");
      return;
    }
    setMsg("");
    roundNo += 1;

    const level = $("level").value;
    const count = Number($("ruleCount").value);
    ruleSet = generateRuleSet(level, count);

    renderRules(ruleSet, roundNo);

    // random first turn each round
    turn = randInt(0, names.length-1);
    updateTurnUI();

    // enable start
    $("startBtn").disabled = false;
    enablePlayButtons(false);
    running = false;
    stopTimer();
    updateTimeUI();
    setStatus("ë£° í™•ì¸ í›„, 3-2-1 ì‹œì‘ì„ ëˆ„ë¥´ì„¸ìš”.");
    toast("ìƒˆ ë£° ìƒì„±!");
    beep(640, 70); vibe(25);
  }

  async function countdownAndStart(){
    if(!ruleSet || !names.length) return;

    // try to resume audio context on user gesture
    if($("sound").value === "on"){
      try{
        audioCtx ||= new (window.AudioContext || window.webkitAudioContext)();
        await audioCtx.resume();
      }catch(e){}
    }

    running = false;
    enablePlayButtons(false);
    setMsg("");
    setStatus("ì¤€ë¹„â€¦");
    $("startBtn").disabled = true;

    const hud = ["3", "2", "1", "GO!"];
    for(let i=0;i<hud.length;i++){
      setStatus(`ì‹œì‘ ${hud[i]}`);
      beep(520 + i*90, 90, 0.06);
      vibe(20 + i*10);
      await new Promise(r=>setTimeout(r, 650));
    }

    // start round
    running = true;
    timeLeft = Number($("roundSec").value);
    updateTimeUI();
    enablePlayButtons(true);
    setStatus("ì§„í–‰! (ì‹¤ìˆ˜í•˜ë©´ OUT)");
    beep(880, 120, 0.05); vibe(40);

    stopTimer();
    timer = setInterval(()=>{
      if(!running) return;
      timeLeft--;
      updateTimeUI();

      // drama at end
      if(timeLeft === 5){ beep(740, 110, 0.05); vibe(35); toast("5ì´ˆ ë‚¨ìŒ!"); }
      if(timeLeft <= 0){
        running = false;
        stopTimer();
        enablePlayButtons(false);
        setStatus("ë¼ìš´ë“œ ì¢…ë£Œ! (ì•„ì§ ì•ˆ ëë‚¬ìœ¼ë©´ ë‹¤ìŒ ë¼ìš´ë“œë¡œ)");
        $("startBtn").disabled = false;
        toast("ë¼ìš´ë“œ ì¢…ë£Œ");
        beep(420, 140, 0.06); vibe(60);
      }
    }, 1000);
  }

  function prevTurn(){
    if(!names.length || !running) return;
    turn = (turn - 1 + names.length) % names.length;
    updateTurnUI();
    beep(520, 50, 0.03);
  }
  function nextTurn(){
    if(!names.length || !running) return;
    turn = (turn + 1) % names.length;
    updateTurnUI();
    beep(560, 50, 0.03);
  }

  function fail(){
    if(!names.length) return;
    const who = names[turn];
    beep(200, 180, 0.07); vibe(120);
    toast(`OUT: ${who}`);
    setStatus(`ğŸš« OUT: ${who} (ì»¤í”¼/ë²Œì¹™ í›„ë³´!)`);
    // advance turn so game continues
    turn = (turn + 1) % names.length;
    updateTurnUI();
  }

  function reset(){
    stopTimer();
    roundNo = 0;
    ruleSet = null;
    names = [];
    turn = 0;
    running = false;
    timeLeft = 0;
    updateTurnUI();
    updateTimeUI();
    $("roundNo").textContent = "0";
    $("rules").innerHTML = `
      <div class="ruleItem">
        <span class="dot blue"></span>
        <div>ì•„ì§ ë£°ì´ ì—†ì–´ìš”. <b>ìƒˆ ë£° ìƒì„±</b>ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
      </div>
    `;
    $("startBtn").disabled = true;
    enablePlayButtons(false);
    setStatus("ë£° ìƒì„± í›„ ì‹œì‘í•˜ì„¸ìš”.");
    setMsg("");
    toast("ë¦¬ì…‹");
    beep(360, 90, 0.05); vibe(40);
  }

  // ======= events =======
  $("genBtn").addEventListener("click", genRules);
  $("startBtn").addEventListener("click", countdownAndStart);
  $("prevBtn").addEventListener("click", prevTurn);
  $("nextBtn").addEventListener("click", nextTurn);
  $("failBtn").addEventListener("click", fail);
  $("resetBtn").addEventListener("click", reset);

  // initial
  setStatus("ë£° ìƒì„± í›„ ì‹œì‘í•˜ì„¸ìš”.");
});
</script>
</body>
</html>
