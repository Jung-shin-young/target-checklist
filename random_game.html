<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>ğŸ± ë©€í‹°ë³¼ í•€ë³¼ ë°°í‹€ (Chaos Arena)</title>
  <style>
    :root{ --r:16px; }
    body{ margin:0; background:#0b0f14; color:#e9eef6; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif; }
    .wrap{ max-width:980px; margin:0 auto; padding:14px; }
    .card{ background:#111826; border:1px solid #223049; border-radius:var(--r); padding:12px; box-shadow:0 8px 22px rgba(0,0,0,.35); }
    h1{ font-size:18px; margin:0 0 6px; }
    .muted{ color:#a9b6cc; font-size:13px; line-height:1.35; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:8px; }
    textarea,select,button{
      border:1px solid #2a3a57; background:#0e1522; color:#e9eef6;
      border-radius:12px; padding:10px 12px; font-size:14px; outline:none;
    }
    textarea{ width:100%; min-height:86px; resize:vertical; }
    button{ cursor:pointer; background:#1a2a46; }
    button.primary{ background:#2d5bff; border-color:#2d5bff; }
    button.danger{ background:#ff3b3b; border-color:#ff3b3b; color:#fff; }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .pill{ display:inline-flex; gap:8px; align-items:center; border:1px solid #2a3a57; padding:8px 10px; border-radius:999px; background:#0e1522; }
    .sep{ height:1px; background:#223049; margin:10px 0; }
    .grid{ display:grid; grid-template-columns: 1fr; gap:10px; }
    @media(min-width:860px){ .grid{ grid-template-columns: 1.1fr .9fr; } }

    /* í´ë¦­ ì”¹í˜ ë°©ì§€ */
    .controls{ position:relative; z-index:10; }
    canvas{ position:relative; z-index:1; width:100%; height:auto; display:block; border-radius:14px; border:1px solid #223049; background:#0e1522; touch-action:manipulation; }

    .hud{ display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .big{ font-size:26px; font-weight:900; letter-spacing:.3px; }
    .timer{ font-size:40px; font-weight:900; letter-spacing:1px; }
    .panel{ background:#0e1522; border:1px solid #223049; border-radius:14px; padding:12px; }
    .bar{ height:10px; border:1px solid #2a3a57; border-radius:999px; overflow:hidden; }
    .bar > i{ display:block; height:100%; width:0%; background:#2d5bff; }
    .pLine{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 10px; border:1px solid #223049; border-radius:12px; margin-top:8px; }
    .name{ font-weight:800; }
    .score{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color:#cfe3ff; }
    .flash{ animation: flash 0.12s linear 0s 6; }
    @keyframes flash { 0%{filter:brightness(1);} 50%{filter:brightness(1.7);} 100%{filter:brightness(1);} }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ğŸ± ë©€í‹°ë³¼ í•€ë³¼ ë°°í‹€ (ìš´ë¹¨ 100%)</h1>
    <div class="muted">
      ì¡°ì‘ ì—†ìŒ. ê³µ(ë©€í‹°ë³¼)ì´ íŠ€ë©´ì„œ <b>ëˆ„êµ¬ êµ¬ì—­ì„ ë§ì´ ë•Œë¦¬ëƒ</b>ë¡œ ê²°ì •ë¨.  
      ì œí•œì‹œê°„ ëë‚˜ë©´ <b>ê°€ì¥ ë§ì´ ë§ì€ ì‚¬ëŒ(ìœ„í—˜ 1ë“±)</b>ì´ ì»¤í”¼ ì˜ê¸°.
    </div>

    <div class="row controls">
      <textarea id="names" placeholder="ì´ë¦„ì„ ì¤„ë°”ê¿ˆìœ¼ë¡œ ì…ë ¥ (ìµœëŒ€ 10ëª…)
ì˜ˆ:
ì² ìˆ˜
ì˜í¬
ë¯¼ìˆ˜"></textarea>
    </div>

    <div class="row controls">
      <span class="pill">ì‹œê°„(ì´ˆ)
        <select id="seconds">
          <option value="12">12</option>
          <option value="18" selected>18</option>
          <option value="25">25</option>
        </select>
      </span>
      <span class="pill">ê³µ ê°œìˆ˜
        <select id="balls">
          <option value="3">3</option>
          <option value="5" selected>5 (ì¶”ì²œ)</option>
          <option value="8">8 (ë‚œì¥íŒ)</option>
        </select>
      </span>
      <span class="pill">ë‚œì´ë„
        <select id="chaos">
          <option value="1">ë³´í†µ</option>
          <option value="2" selected>ë¹¡ì…ˆ</option>
          <option value="3">ë¯¸ì¹¨</option>
        </select>
      </span>
    </div>

    <div class="row controls">
      <button class="primary" id="prepBtn">ë³´ë“œ ì¤€ë¹„</button>
      <button class="primary" id="startBtn" disabled>START â–¶</button>
      <button id="rerollBtn" disabled>ë‚œìˆ˜ ë¦¬ì…‹</button>
      <button class="danger" id="resetBtn">ë¦¬ì…‹</button>
      <span class="muted" id="msg"></span>
    </div>

    <div class="sep"></div>

    <div class="grid">
      <div>
        <canvas id="cv" width="900" height="900"></canvas>
      </div>
      <div class="panel">
        <div class="hud">
          <div>
            <div class="muted">ë‚¨ì€ ì‹œê°„</div>
            <div class="timer" id="timeLeft">--</div>
          </div>
          <div>
            <div class="muted">ìƒíƒœ</div>
            <div class="big" id="status">ëŒ€ê¸°</div>
          </div>
        </div>

        <div class="sep"></div>
        <div class="muted">ìœ„í—˜ë„(ë§ì€ íšŸìˆ˜)</div>
        <div id="plist"></div>

        <div class="sep"></div>
        <div class="muted">ê²°ê³¼</div>
        <div class="big" id="result">-</div>
      </div>
    </div>
  </div>
</div>

<script>
window.addEventListener("DOMContentLoaded", () => {
  const $ = (id)=>document.getElementById(id);
  const msg = $("msg");

  window.onerror = (m, s, line, col) => {
    msg.textContent = `JS ì˜¤ë¥˜: ${m} (line ${line}:${col})`;
  };

  function setMsg(t=""){ msg.textContent = t; }
  function setStatus(t){ $("status").textContent = t; }
  function setResult(t){ $("result").textContent = t; }

  // crypto random
  function rand01(){
    const u = new Uint32Array(1);
    crypto.getRandomValues(u);
    return u[0] / 0xFFFFFFFF;
  }
  function randInt(min, maxInc){
    return min + Math.floor(rand01() * (maxInc - min + 1));
  }
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = randInt(0,i);
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }

  function parseNames(){
    const raw = $("names").value.split("\n").map(s=>s.trim()).filter(Boolean);
    const seen = new Set();
    const out = [];
    for(const n of raw){
      if(!seen.has(n)){ seen.add(n); out.push(n); }
    }
    return out.slice(0,10);
  }

  const cv = $("cv");
  const ctx = cv.getContext("2d");
  const W = cv.width, H = cv.height;
  const cx = W/2, cy = H/2;

  // arena
  const R = 360;
  const wallR = 330;
  const bumperR = 12;

  let ready=false, running=false;
  let players=[], scores=[], maxScore=1;
  let bumpers=[], balls=[];
  let secondsLeft = 0;
  let tickTimer = null;

  function buildPlayerList(){
    const plist = $("plist");
    plist.innerHTML = "";
    for(let i=0;i<players.length;i++){
      const line = document.createElement("div");
      line.className = "pLine";
      line.innerHTML = `
        <div style="min-width:110px" class="name">${players[i]}</div>
        <div style="flex:1">
          <div class="bar"><i id="bar${i}"></i></div>
        </div>
        <div class="score" id="score${i}">0</div>
      `;
      plist.appendChild(line);
    }
  }

  function updateBars(){
    maxScore = Math.max(1, ...scores);
    for(let i=0;i<scores.length;i++){
      const pct = Math.min(100, Math.round((scores[i] / maxScore) * 100));
      const bar = document.getElementById(`bar${i}`);
      const sc = document.getElementById(`score${i}`);
      if(bar) bar.style.width = pct + "%";
      if(sc) sc.textContent = String(scores[i]);
    }
  }

  function resetRuntime(){
    stopClock();
    running=false;
    secondsLeft = 0;
    $("timeLeft").textContent = "--";
    setStatus("ëŒ€ê¸°");
    setResult("-");
  }

  function stopClock(){
    if(tickTimer){ clearInterval(tickTimer); tickTimer=null; }
  }

  function prep(){
    players = parseNames();
    if(players.length < 3){
      setMsg("ìµœì†Œ 3ëª…ë¶€í„° ê°€ëŠ¥!");
      ready=false;
      $("startBtn").disabled = true;
      $("rerollBtn").disabled = true;
      resetRuntime();
      draw();
      return;
    }
    setMsg(`ë³´ë“œ ì¤€ë¹„ ì™„ë£Œ: ${players.length}ëª…`);
    scores = Array(players.length).fill(0);
    updateBars();
    buildPlayerList();

    // build player segments (angles)
    // and inner bumpers
    bumpers = [];
    const chaos = Number($("chaos").value);
    const ring = 220;

    // bumpers random (more chaos => more bumpers)
    const bumperCount = 18 + chaos*10;
    for(let i=0;i<bumperCount;i++){
      const a = rand01() * Math.PI*2;
      const rr = ring + (rand01()-0.5) * (80 + chaos*20);
      bumpers.push({
        x: cx + Math.cos(a)*rr,
        y: cy + Math.sin(a)*rr,
        r: bumperR + rand01()*3
      });
    }

    // balls empty until start
    balls = [];
    ready=true;
    $("startBtn").disabled = false;
    $("rerollBtn").disabled = false;
    resetRuntime();
    draw();
  }

  function reroll(){
    if(!ready) return;
    // just re-prep bumpers randomness without touching names/scores
    setMsg("ë‚œìˆ˜ ë¦¬ì…‹! ë³´ë“œê°€ ì‚´ì§ ë°”ë€œ");
    const chaos = Number($("chaos").value);
    bumpers = [];
    const ring = 220;
    const bumperCount = 18 + chaos*10;
    for(let i=0;i<bumperCount;i++){
      const a = rand01() * Math.PI*2;
      const rr = ring + (rand01()-0.5) * (80 + chaos*20);
      bumpers.push({ x: cx + Math.cos(a)*rr, y: cy + Math.sin(a)*rr, r: bumperR + rand01()*3 });
    }
    draw();
    setTimeout(()=>setMsg(""), 700);
  }

  function start(){
    if(!ready) return;
    if(running) return;

    // reset scores each round
    scores = Array(players.length).fill(0);
    updateBars();
    setResult("-");

    const chaos = Number($("chaos").value);
    const ballCount = Number($("balls").value);
    const speedBase = 3.0 + chaos*0.8;

    balls = [];
    for(let i=0;i<ballCount;i++){
      const a = rand01()*Math.PI*2;
      const rr = rand01()*80;
      const x = cx + Math.cos(a)*rr;
      const y = cy + Math.sin(a)*rr;
      const ang = rand01()*Math.PI*2;
      balls.push({
        x, y, r: 10 + rand01()*3,
        vx: Math.cos(ang) * (speedBase + rand01()*2.2),
        vy: Math.sin(ang) * (speedBase + rand01()*2.2)
      });
    }

    running=true;
    setStatus("ì§„í–‰ì¤‘");
    $("cv").classList.remove("flash");

    // clock
    const total = Number($("seconds").value);
    secondsLeft = total;
    $("timeLeft").textContent = String(secondsLeft);
    stopClock();
    tickTimer = setInterval(()=>{
      if(!running) return;
      secondsLeft--;
      $("timeLeft").textContent = String(secondsLeft);

      // little drama near end
      if(secondsLeft <= 5){
        $("cv").classList.add("flash");
      }

      if(secondsLeft <= 0){
        finish();
      }
    }, 1000);
  }

  function finish(){
    running=false;
    stopClock();
    setStatus("ì¢…ë£Œ");

    // loser = max score (most hit)
    const max = Math.max(...scores);
    const idxs = [];
    for(let i=0;i<scores.length;i++) if(scores[i]===max) idxs.push(i);
    const loserIdx = idxs[randInt(0, idxs.length-1)];
    const loser = players[loserIdx];

    setResult(`â˜• ${loser} ì»¤í”¼ ì˜ê¸°! (ìœ„í—˜ ${max})`);
    setMsg("ë! ë‹¤ì‹œ í•˜ë ¤ë©´ START");
  }

  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

  function collideCircle(b, px, py, pr, bounce=1.0){
    const dx = b.x - px;
    const dy = b.y - py;
    const dist = Math.hypot(dx,dy);
    const minD = b.r + pr;
    if(dist < minD && dist > 0.0001){
      const nx = dx / dist;
      const ny = dy / dist;
      const overlap = (minD - dist);
      b.x += nx * overlap;
      b.y += ny * overlap;

      const vn = b.vx*nx + b.vy*ny;
      if(vn < 0){
        b.vx -= (1 + bounce) * vn * nx;
        b.vy -= (1 + bounce) * vn * ny;
      }
      // tiny chaos
      b.vx += (rand01()-0.5)*0.25;
      b.vy += (rand01()-0.5)*0.25;
      return true;
    }
    return false;
  }

  function wallBounce(b){
    // bounce inside circle wall
    const dx = b.x - cx;
    const dy = b.y - cy;
    const dist = Math.hypot(dx,dy);
    const limit = wallR - b.r;
    if(dist > limit && dist > 0.0001){
      const nx = dx / dist;
      const ny = dy / dist;
      b.x = cx + nx * limit;
      b.y = cy + ny * limit;

      // reflect velocity across normal
      const vn = b.vx*nx + b.vy*ny;
      if(vn > 0){
        b.vx -= 2 * vn * nx;
        b.vy -= 2 * vn * ny;
      }
      // add energy a bit for excitement
      b.vx *= 1.03;
      b.vy *= 1.03;
    }
  }

  function scoreIfHitPlayer(b){
    // player region is outer ring segments: angle determines whose "shield" got hit
    const dx = b.x - cx;
    const dy = b.y - cy;
    const dist = Math.hypot(dx,dy);

    // only count when ball is near outer ring
    if(dist < wallR - 25) return;

    let ang = Math.atan2(dy, dx);
    if(ang < 0) ang += Math.PI*2;
    const seg = (Math.PI*2) / players.length;
    const idx = Math.min(players.length-1, Math.floor(ang / seg));
    scores[idx] += 1;
    updateBars();
  }

  function draw(){
    ctx.clearRect(0,0,W,H);

    // bg
    ctx.fillStyle = "#0e1522";
    ctx.fillRect(0,0,W,H);

    // outer ring segments
    if(players.length){
      const seg = (Math.PI*2)/players.length;
      for(let i=0;i<players.length;i++){
        const a0 = i*seg;
        const a1 = a0 + seg;

        ctx.beginPath();
        ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,wallR+10,a0,a1,false);
        ctx.closePath();
        ctx.globalAlpha = 0.10;
        ctx.fillStyle = "#2d5bff";
        ctx.fill();
        ctx.globalAlpha = 1;

        // name labels
        const mid = (a0+a1)/2;
        const tx = cx + Math.cos(mid)*(wallR-10);
        const ty = cy + Math.sin(mid)*(wallR-10);
        ctx.fillStyle = "#e9eef6";
        ctx.font = "18px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(players[i], tx, ty);
      }
    }

    // wall circle
    ctx.strokeStyle = "#223049";
    ctx.lineWidth = 6;
    ctx.beginPath();
    ctx.arc(cx,cy,wallR,0,Math.PI*2);
    ctx.stroke();

    // bumpers
    ctx.fillStyle = "#cfe3ff";
    for(const p of bumpers){
      ctx.beginPath();
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fill();
    }

    // balls
    for(const b of balls){
      ctx.beginPath();
      ctx.fillStyle = "#ffffff";
      ctx.arc(b.x,b.y,b.r,0,Math.PI*2);
      ctx.fill();

      ctx.globalAlpha = 0.25;
      ctx.beginPath();
      ctx.fillStyle = "#ffffff";
      ctx.arc(b.x - 5, b.y - 6, b.r*0.55, 0, Math.PI*2);
      ctx.fill();
      ctx.globalAlpha = 1;
    }

    // hint
    if(!ready){
      ctx.fillStyle = "rgba(0,0,0,.35)";
      ctx.fillRect(0,0,W,H);
      ctx.fillStyle = "#e9eef6";
      ctx.font = "30px system-ui";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("ì´ë¦„ ì…ë ¥ â†’ ë³´ë“œ ì¤€ë¹„", cx, cy);
    } else if(ready && !running && balls.length===0){
      ctx.fillStyle = "#a9b6cc";
      ctx.font = "24px system-ui";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("STARTë¥¼ ëˆŒëŸ¬ ì‹œì‘!", cx, cy);
    }
  }

  function step(){
    if(running){
      const chaos = Number($("chaos").value);
      const drag = 0.999 - chaos*0.0006; // more chaos => less drag
      const jitter = 0.035 + chaos*0.02;

      for(const b of balls){
        // move
        b.x += b.vx;
        b.y += b.vy;

        // small random "wind"
        b.vx += (rand01()-0.5)*jitter;
        b.vy += (rand01()-0.5)*jitter;

        // bumpers collision
        for(const p of bumpers){
          if(collideCircle(b, p.x, p.y, p.r, 1.05)){
            // minor speed boost on bumper
            b.vx *= 1.01; b.vy *= 1.01;
          }
        }

        // wall bounce + score
        wallBounce(b);
        scoreIfHitPlayer(b);

        // drag clamp
        b.vx *= drag;
        b.vy *= drag;
        b.vx = clamp(b.vx, -12, 12);
        b.vy = clamp(b.vy, -12, 12);
      }
    }

    draw();
    requestAnimationFrame(step);
  }

  $("prepBtn").addEventListener("click", prep);
  $("startBtn").addEventListener("click", start);
  $("rerollBtn").addEventListener("click", reroll);
  $("resetBtn").addEventListener("click", () => {
    ready=false; running=false;
    players=[]; bumpers=[]; balls=[]; scores=[];
    stopClock();
    $("timeLeft").textContent="--";
    setStatus("ëŒ€ê¸°");
    setResult("-");
    setMsg("");
    $("startBtn").disabled = true;
    $("rerollBtn").disabled = true;
    $("plist").innerHTML = "";
    draw();
  });

  // init
  setStatus("ëŒ€ê¸°");
  setResult("-");
  $("startBtn").disabled = true;
  $("rerollBtn").disabled = true;
  draw();
  requestAnimationFrame(step);
});
</script>
</body>
</html>
