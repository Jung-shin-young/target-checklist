<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SP3 HEV FCA 관리자</title>

<style>
body{font-family:system-ui;margin:18px}
.box{border:1px solid #ddd;border-radius:14px;padding:12px;margin-bottom:14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input,button,textarea,select{
  border:1px solid #ccc;border-radius:12px;
  padding:10px;font-size:14px
}
button{background:#f6f6f6}
button.primary{background:#111;color:#fff;border-color:#111}
button.danger{background:#b42318;color:#fff;border-color:#b42318}
textarea{width:100%;min-height:100px}
.vin{font-size:20px;font-weight:800}
.card{border:1px solid #e3e3e3;border-radius:14px;padding:10px}
.list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
</style>
</head>
<body>

<h2>SP3 HEV FCA 관리자(Admin)</h2>

<div id="loginBox" class="box">
  <div class="row">
    <input id="adminPw" type="password" placeholder="관리자 비밀번호 입력"/>
    <button class="primary" onclick="login()">접속</button>
  </div>
  <div id="loginMsg" style="color:#b42318;margin-top:6px"></div>
</div>

<div id="app" style="display:none">

<div class="box">
  <div class="row">
    <input id="search" placeholder="VIN 검색"/>
    <span>총 <b id="cntTotal">-</b></span>
  </div>
</div>

<div class="box">
  <b>버전 설정</b>
  <div class="row" style="margin-top:8px">
    <input id="camVer" placeholder="카메라 버전"/>
    <input id="camPart" placeholder="카메라 품번"/>
  </div>
  <div class="row">
    <input id="drvVer" placeholder="DRV 버전"/>
    <input id="drvPart" placeholder="DRV 품번"/>
  </div>
  <button class="primary" onclick="saveSettings()">버전 저장</button>
</div>

<div class="box">
  <b>VIN 대량 추가</b>
  <div class="row" style="margin-top:8px">
    <select id="bulkGrade">
      <option value="F">카메라(F)</option>
      <option value="F+">DRV(F+)</option>
    </select>
  </div>
  <textarea id="bulkText"></textarea>
  <button class="primary" onclick="bulkAdd()">추가</button>
</div>

<div class="box">
  <b>VIN 대량 삭제</b>
  <textarea id="delText"></textarea>
  <button class="danger" onclick="bulkDelete()">삭제</button>
</div>

<div class="box">
  <b>VIN 목록</b>
  <div class="list" id="list"></div>
</div>

</div>

<script>

const SUPABASE_URL = "https://gpdtgrbiyrgekjtgxpgf.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdwZHRncmJpeXJnZWtqdGd4cGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1ODI3ODAsImV4cCI6MjA4NTE1ODc4MH0.tLZb3obtmHgWMTiKf4xhbsiOqmg80o2MPibQhB5Ywco";

const TABLE = "checklist_sp3_hev_fca";
const SETTINGS = "sp3_hev_fca_settings";

let items=[];

function headers(){
  return {
    "apikey": SUPABASE_ANON_KEY,
    "Authorization": "Bearer "+SUPABASE_ANON_KEY,
    "Content-Type":"application/json"
  };
}

function login(){
  const pw = document.getElementById("adminPw").value;
  if(pw !== "1234"){
    document.getElementById("loginMsg").innerText="비밀번호 틀림";
    return;
  }
  document.getElementById("loginBox").style.display="none";
  document.getElementById("app").style.display="block";
  load();
  loadSettings();
}

async function load(){
  const r = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}?select=*`,{headers:headers()});
  items = await r.json();
  document.getElementById("cntTotal").innerText=items.length;
  render();
}

function render(){
  const box=document.getElementById("list");
  box.innerHTML="";
  const q=document.getElementById("search").value||"";
  items.filter(x=>String(x.vin).includes(q))
  .forEach(it=>{
    const d=document.createElement("div");
    d.className="card";
    d.innerHTML=`
      <div class="vin">${it.vin}</div>
      <div>등급: ${it.grade||"-"}</div>
      <div>완료: ${it.update_done?"Y":"N"}</div>
      <div class="row" style="margin-top:6px">
        <select onchange="changeGrade('${it.id}',this.value)">
          <option value="F" ${it.grade==="F"?"selected":""}>카메라</option>
          <option value="F+" ${it.grade==="F+"?"selected":""}>DRV</option>
        </select>
        <button onclick="toggleUpdate('${it.id}',${it.update_done})">
          ${it.update_done?"완료해제":"완료처리"}
        </button>
        <button class="danger" onclick="deleteOne('${it.vin}')">삭제</button>
      </div>
    `;
    box.appendChild(d);
  });
}

document.getElementById("search").oninput=render;

async function changeGrade(id,val){
  await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}?id=eq.${id}`,{
    method:"PATCH",
    headers:headers(),
    body:JSON.stringify({grade:val})
  });
  load();
}

async function toggleUpdate(id,curr){
  await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}?id=eq.${id}`,{
    method:"PATCH",
    headers:headers(),
    body:JSON.stringify({
      update_done:!curr
    })
  });
  load();
}

async function deleteOne(vin){
  if(!confirm("삭제할까요?"))return;
  await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}?vin=eq.${vin}`,{
    method:"DELETE",
    headers:headers()
  });
  load();
}

async function bulkAdd(){
  const vins=(document.getElementById("bulkText").value||"")
  .split(/\s+/).filter(Boolean);
  const grade=document.getElementById("bulkGrade").value;

  const rows=vins.map(v=>({vin:v,grade:grade,status:"미완료"}));

  await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}?on_conflict=vin`,{
    method:"POST",
    headers:headers(),
    body:JSON.stringify(rows)
  });
  load();
}

async function bulkDelete(){
  const vins=(document.getElementById("delText").value||"")
  .split(/\s+/).filter(Boolean);
  if(!confirm("정말 삭제?"))return;
  const list=vins.map(v=>`"${v}"`).join(",");
  await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}?vin=in.(${list})`,{
    method:"DELETE",
    headers:headers()
  });
  load();
}

async function loadSettings(){
  const r=await fetch(`${SUPABASE_URL}/rest/v1/${SETTINGS}?select=*&id=eq.main`,{headers:headers()});
  const s=(await r.json())[0];
  if(!s)return;
  camVer.value=s.cam_version||"";
  camPart.value=s.cam_part||"";
  drvVer.value=s.drv_version||"";
  drvPart.value=s.drv_part||"";
}

async function saveSettings(){
  await fetch(`${SUPABASE_URL}/rest/v1/${SETTINGS}?id=eq.main`,{
    method:"PATCH",
    headers:headers(),
    body:JSON.stringify({
      cam_version:camVer.value,
      cam_part:camPart.value,
      drv_version:drvVer.value,
      drv_part:drvPart.value
    })
  });
  alert("저장 완료");
}

</script>
</body>
</html>
