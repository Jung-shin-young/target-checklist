<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SP3 HEV FCA 미동작 실차 조치 현황</title>
  <style>
    body{font-family:system-ui,-apple-system;margin:18px;line-height:1.35}
    .box{border:1px solid #ddd;border-radius:14px;padding:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,button,textarea,select{border:1px solid #ccc;border-radius:12px;padding:10px;font-size:14px}
    button{background:#f6f6f6}
    button:disabled{opacity:.55}
    .pill{border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-size:13px;background:#fff}
    .pillBtn{cursor:pointer}
    .pillBtn.active{background:#111;color:#fff;border-color:#111}
    /* ✅ 클릭 불가(현황 표시) pill */
    .pillStat{
      cursor:default;
      background:#f6f6f6;
      border-color:#eee;
      color:#111;
    }
    .pillStat b{font-weight:800}
    /* ========================= */
/* 카메라 / DRV 색상 구분 */
/* ========================= */

.pillBtn.camera{
  border-color:#cfe3ff;
  background:#eef6ff;
  color:#0b3a75;
}

.pillBtn.drv{
  border-color:#e6d7ff;
  background:#f6f0ff;
  color:#3b1b7a;
}

/* 선택(active) 상태 */
.pillBtn.camera.active{
  background:#1d4ed8;
  border-color:#1d4ed8;
  color:#fff;
}

.pillBtn.drv.active{
  background:#6d28d9;
  border-color:#6d28d9;
  color:#fff;
}
    .list{margin-top:14px;display:flex;flex-direction:column;gap:10px}
    .card{border:1px solid #e3e3e3;border-radius:16px;padding:12px}
    .vin{font-size:26px;font-weight:800}
    .muted{color:#666;font-size:13px}
    .tabs button{border-radius:999px;padding:8px 12px}
    .tabs button.active{background:#111;color:#fff;border-color:#111}
    .right{margin-left:auto}
    .sectionTitle{margin-top:10px;margin-bottom:6px;font-weight:700}
    .warn{color:#b42318;font-weight:700}

    /* 하단 고정 탭 바 */
    #bottomTabs{display:flex;width:100%;gap:8px}
    #bottomTabs button{flex:1;text-align:center;white-space:nowrap}
    .bottomBar{
      position:fixed;left:0;right:0;bottom:0;
      background:#fff;border-top:1px solid #ddd;
      padding:10px 12px;z-index:9999;
    }
    .bottomInner{
      max-width:980px;margin:0 auto;
      display:flex;gap:8px;flex-wrap:wrap;
    }
    body{padding-bottom:86px;}

    @media (max-width: 520px) {
      .summaryRow{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
      .summaryRow #search{width:100% !important;box-sizing:border-box}
      .summaryPct{width:100%}
      .growMobile{width:100%}
      select.growMobile{width:100%}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
</head>
<body>
  <h2>SP3 HEV FCA 미동작 실차 조치 현황</h2>

  <div class="box">
    <div class="row" style="justify-content:space-between">
      <div>사용자: <b id="nickLabel">(미설정)</b></div>
      <div class="row">
        <button id="nickBtn">닉네임 변경</button>
        <button id="downloadBtn">엑셀 다운로드(XLSX)</button>
      </div>
    </div>

    <!-- ✅ 버전 고정 -->
    <div class="row" style="margin-top:8px">
      <span class="pill">카메라: <b id="verCam">-</b></span>
      <span class="pill">DRV: <b id="verDrv">-</b></span>
    </div>

    <div class="row summaryRow" style="margin-top:10px">
      <input id="search" placeholder="VIN 검색(4자리)" inputmode="numeric" style="width:150px"/>

      <!-- ✅ F/F+ 필터(문구 변경) -->
      <span class="pill pillBtn active" id="gAll">전체</span>
      <span class="pill pillBtn camera" id="gF">카메라</span>
      <span class="pill pillBtn drv" id="gFp">DRV</span>

      <span class="pill pillStat" id="cntTotal">총 -</span>
      <span class="pill pillStat" id="cntDone">완료 -</span>
      <span class="pill pillStat" id="cntRemain">잔여 -</span>

      <div class="summaryPct" style="margin-top:10px;width:100%">
        <div class="muted">완료율: <b id="pctText">-</b></div>
        <div style="height:12px;border:1px solid #ddd;border-radius:999px;overflow:hidden;background:#eee">
          <div id="pctBar" style="height:100%;width:0%;background:linear-gradient(90deg,#4caf50,#2e7d32);transition:width .25s ease"></div>
        </div>
      </div>

      <span class="muted" id="saving"></span>
      <span class="right muted" id="rt"></span>
    </div>

    <!-- ✅ 상단 상태탭(5개만) -->
    <div class="row tabs" style="margin-top:10px" id="topTabs">
      <button data-tab="all" class="active">전체</button>
      <button data-tab="작업중">작업중</button>
      <button data-tab="완료">완료</button>
      <button data-tab="기타">기타</button>
      <button data-tab="remain">미완료</button>
    </div>

    <!-- ✅ 전체 탭에서만 지역별 요약 -->
    <div id="regionSummaryWrap" style="display:none;margin-top:10px">
      <div class="sectionTitle">지역별 현황(탭 클릭 시 해당 지역만 보기)</div>
      <div class="row" id="regionSummary"></div>
      <div class="row" style="margin-top:6px">
        <span class="muted" id="regionFilterHint"></span>
      </div>
    </div>
  </div>

  <div class="list" id="list"></div>

<script>
/* ======= 설정(필수) ======= */
const SUPABASE_URL = "https://gpdtgrbiyrgekjtgxpgf.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdwZHRncmJpeXJnZWtqdGd4cGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1ODI3ODAsImV4cCI6MjA4NTE1ODc4MH0.tLZb3obtmHgWMTiKf4xhbsiOqmg80o2MPibQhB5Ywco";
const TABLE_NAME = "checklist_sp3_hev_fca";
/* ============================ */

/* ✅ 버전 고정(요청 반영) */
const VERSION = {
  camera: "1.03 / 2621000",
  drv: "1.06 / 2622000"
};

/* ✅ 지역 리스트 */
const REGION_LIST = [
  "광주 출고",
  "광주 공장",
  "광주 PDI",      // ✅ 추가
  "광명 출고",
  "덕평 출고",
  "PBV 컨버전 출고",
  "화성 출고",
  "고덕 출고",
  "서산 출고",
  "충주 출고",
  "신태인 출고",
  "경산 출고",
  "기타",
  "확인 필요"
];

let NICK = localStorage.getItem("checklist_nick") || "";
let tab = "all";
let items = [];
let saving = false;

let gradeFilter = "all";   // 'all' | 'F' | 'F+'
let regionFilter = null;   // null | region string

const $ = (id)=>document.getElementById(id);

function mustNick(){
  while(!NICK){
    const n = prompt("닉네임을 입력하세요 (예: 신영/홍길동)");
    if(!n) continue;
    NICK = n.trim();
    localStorage.setItem("checklist_nick", NICK);
  }
  $("nickLabel").innerText = NICK;
}
$("nickBtn").onclick = ()=>{
  NICK = "";
  localStorage.removeItem("checklist_nick");
  mustNick();
};

function headers(preferReturn=true){
  const h = {
    "apikey": SUPABASE_ANON_KEY,
    "Authorization": "Bearer " + SUPABASE_ANON_KEY,
    "Content-Type": "application/json",
  };
  if(preferReturn) h["Prefer"] = "return=representation";
  return h;
}

function setSaving(v){
  saving=v;
  $("saving").innerText = v ? "저장중..." : "";
  document.querySelectorAll("button,select,input,textarea").forEach(el=>{
    if(el.id === "nickBtn") return;
    if(el.id === "search") return;
    el.disabled = v;
  });
  $("nickBtn").disabled = false;
}

function normStatus(s){
  s = (s || "").toString().trim();
  if (s === "" || s === "잔여" || s === "남음" || s === "remain" || s === "미완" || s === "미완료") return "미완료";
  if (s === "작업중") return "작업중";
  if (s === "기타") return "기타";
  if (s === "완료") return "완료"; // 레거시 보호
  return "미완료";
}

function formatKST(iso){
  if(!iso) return "-";
  const d = new Date(iso);
  return new Intl.DateTimeFormat("ko-KR", {
    timeZone: "Asia/Seoul",
    year: "numeric", month: "2-digit", day: "2-digit",
    hour: "2-digit", minute: "2-digit", second: "2-digit",
    hour12: false
  }).format(d);
}

function effGrade(it){
  const g = (it.grade || "").toString().trim();
  if(g === "F" || g === "F+") return g;
  return "";
}
function gradeLabel(g){
  if(g === "F") return "카메라";
  if(g === "F+") return "DRV";
  return "-";
}

function effRegion(it){
  const r = (it.region || "").toString().trim();
  return r ? r : "확인 필요";
}
function effUpdateDone(it){ return !!it.update_done; }

function derivedState(it){
  if(effUpdateDone(it)) return "완료";
  return normStatus(it.status);
}

function regionNeedsMemo(region){ return region === "기타"; }
function isRegionValidForComplete(region, regionMemo){
  if(!region || region === "확인 필요") return false;
  if(regionNeedsMemo(region) && !(regionMemo || "").trim()) return false;
  return true;
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

async function load(){
  const url = `${SUPABASE_URL}/rest/v1/${TABLE_NAME}?select=*`;
  const r = await fetch(url, {headers: headers(true)});
  if(!r.ok){
    $("rt").innerText = "로드 실패";
    console.log(await r.text());
    return;
  }
  items = await r.json();
  $("rt").innerText = "연결됨 ✅";
  render();
}
function renderMine(){
  mustNick();
  const q = $("search").value.trim();

  let view = items.filter(x =>
    (x.updated_by||"") === NICK ||
    (x.update_by||"") === NICK ||
    (x.region_by||"") === NICK
  );

  view = applyGradeFilter(view);
  view = applyRegionFilter(view);

  if(q) view = view.filter(x=>String(x.vin).includes(q));

  view.sort((a,b)=> new Date(b.updated_at||0).getTime() - new Date(a.updated_at||0).getTime());

  // 상단 상태탭 active 해제(내작업 모드)
  document.querySelectorAll("#topTabs button").forEach(btn=>btn.classList.remove("active"));

  renderListInBatches(view);
}

function renderRecent(){
  const q = $("search").value.trim();
  const since = Date.now() - 30*60*1000; // 30분

  let view = items.filter(x =>
    x.updated_at && (new Date(x.updated_at).getTime() >= since)
  );

  view = applyGradeFilter(view);
  view = applyRegionFilter(view);

  if(q) view = view.filter(x=>String(x.vin).includes(q));

  view.sort((a,b)=> new Date(b.updated_at||0).getTime() - new Date(a.updated_at||0).getTime());

  document.querySelectorAll("#topTabs button").forEach(btn=>btn.classList.remove("active"));

  renderListInBatches(view);
}

function applyGradeFilter(view){
  if(gradeFilter === "all") return view;
  return view.filter(x => effGrade(x) === gradeFilter);
}
function applyRegionFilter(view){
  if(!regionFilter) return view;
  return view.filter(x => effRegion(x) === regionFilter);
}

function renderRegionSummary(base){
  $("regionSummaryWrap").style.display = (tab === "all") ? "block" : "none";
  if(tab !== "all") return;

  const wrap = $("regionSummary");
  wrap.innerHTML = "";

  const filtered = applyGradeFilter(base);
  const counts = {};
  REGION_LIST.forEach(r => counts[r] = {total:0, done:0});

  filtered.forEach(it=>{
    const r = effRegion(it);
    if(!counts[r]) counts[r] = {total:0, done:0};
    counts[r].total += 1;
    if(effUpdateDone(it)) counts[r].done += 1;
  });

  REGION_LIST.forEach(r=>{
    const c = counts[r] || {total:0, done:0};
    if(c.total === 0 && r !== "확인 필요") return;
    const pill = document.createElement("span");
    pill.className = "pill pillBtn" + (regionFilter === r ? " active" : "");
    const remain = c.total - c.done;
    pill.textContent = `${r}  ${c.done}/${c.total} (잔여 ${remain})`;
    pill.onclick = ()=>{
      regionFilter = (regionFilter === r) ? null : r;
      render();
    };
    wrap.appendChild(pill);
  });

  const hint = $("regionFilterHint");
  hint.innerHTML = regionFilter
    ? `현재 지역 필터: <b>${regionFilter}</b> (다시 누르면 해제)`
    : "지역별 요약을 눌러 해당 지역만 필터링할 수 있어요.";
}

/* ✅ 배치 렌더링으로 리스트 안보이는 현상 해결 */
function renderListInBatches(view){
  const box = $("list");
  box.innerHTML = "";

  const BATCH = 50;
  let i = 0;

  const order = {"미완료":1,"작업중":2,"기타":3,"완료":4};
  view.sort((a,b)=>
    (order[derivedState(a)]||9)-(order[derivedState(b)]||9) ||
    String(a.vin).localeCompare(String(b.vin))
  );

  function makeCard(it){
    const d = document.createElement("div");
    d.className="card";

    const lastBy = it.updated_by || "-";
    const lastAt = it.updated_at || null;

    const updDone = !!it.update_done;
    const updMark = updDone ? "✅" : "⬜";
    const updBy = it.update_by || "-";
    const updAt = it.update_at || null;

    const reg = effRegion(it);
    const regMemo = it.region_memo || "";
    const regConfirmed = !!it.region_confirmed;
    const regMark = regConfirmed ? "✅" : "⬜";
    const regBy = it.region_by || "-";
    const regAt = it.region_at || null;

    const state = derivedState(it);
    const g = effGrade(it);
    const actionLabel = gradeLabel(g);

    const needsRegion = updDone && !isRegionValidForComplete(reg, regMemo);
    const warnHtml = needsRegion ? `<div class="muted warn">⚠ 완료인데 지역이 미입력 상태입니다.</div>` : "";

    d.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <div class="vin">${it.vin}</div>
          <div class="muted">조치: <b>${actionLabel}</b> <span class="muted">(${g || "-"})</span></div>
          <div class="muted">상태: <b>${state}</b></div>
        </div>
      </div>

      ${warnHtml}

      <div class="muted">업데이트: ${updMark} ${formatKST(updAt)} · ${updBy}</div>
      <div class="muted">지역확정: ${regMark} ${formatKST(regAt)} · ${regBy}</div>
      <div class="muted">최근변경: ${formatKST(lastAt)} · ${lastBy}</div>

      <div class="row" style="margin-top:10px;align-items:center">
        <div class="muted" style="min-width:56px">지역</div>
        <select class="growMobile" onchange="setRegion('${it.id}', this.value)">
          ${REGION_LIST.map(r=>`<option value="${r}" ${r===reg?"selected":""}>${r}</option>`).join("")}
        </select>
        <button onclick="toggleRegionConfirm('${it.id}')">지역확정</button>
      </div>

      <div class="row" style="margin-top:8px;align-items:center;${regionNeedsMemo(reg) ? "" : "display:none"}" id="regionMemoRow_${it.id}">
        <div class="muted" style="min-width:56px">기타메모</div>
        <input class="growMobile" id="regionMemo_${it.id}" placeholder="기타 지역 메모" value="${escapeHtml(regMemo)}" />
        <button onclick="saveRegionMemo('${it.id}')">저장</button>
      </div>

      <div class="muted" style="margin-top:8px">메모: ${it.memo ? escapeHtml(it.memo) : "-"}</div>

      <div class="row" style="margin-top:10px">
        <button onclick="setWorkStatus('${it.id}','미완료')">미완료</button>
        <button onclick="setWorkStatus('${it.id}','작업중')">작업중</button>
        <button onclick="toggleUpdateDone('${it.id}')">완료(업데이트)</button>
        <button onclick="setOther('${it.id}')">기타</button>
      </div>
    `;
    return d;
  }

  function step(){
    const frag = document.createDocumentFragment();
    const end = Math.min(i + BATCH, view.length);
    for(; i < end; i++){
      frag.appendChild(makeCard(view[i]));
    }
    box.appendChild(frag);
    if(i < view.length){
      requestAnimationFrame(step);
    }
  }
  step();
}

function render(){
  const q = $("search").value.trim();

  let view = [...items];

  if(tab !== "all"){
    if(tab === "remain") view = view.filter(x => derivedState(x) === "미완료");
    else view = view.filter(x => derivedState(x) === tab);
  }

  view = applyGradeFilter(view);
  view = applyRegionFilter(view);

  if(q) view = view.filter(x=>String(x.vin).includes(q));

  const baseForCount = applyRegionFilter(applyGradeFilter(items));
  const total = baseForCount.length;
  const done = baseForCount.filter(x=>effUpdateDone(x)).length;

  $("cntTotal").innerText = `총 ${total}`;
  $("cntDone").innerText = `완료 ${done}`;
  $("cntRemain").innerText = `잔여 ${Math.max(0, total - done)}`;

  const pct = total ? Math.round((done / total) * 100) : 0;
  $("pctText").innerText = pct + "%";
  $("pctBar").style.width = pct + "%";

  renderRegionSummary(items);
  renderListInBatches(view);
}

async function patchRow(id, payload){
  const url = `${SUPABASE_URL}/rest/v1/${TABLE_NAME}?id=eq.${encodeURIComponent(id)}`;
  const r = await fetch(url, {method:"PATCH", headers: headers(true), body: JSON.stringify(payload)});
  if(!r.ok){
    alert("저장 실패. 콘솔/권한/RLS 확인 필요");
    console.log(await r.text());
    return false;
  }
  return true;
}
function bumpLastChange(payload, nowIso){
  payload.updated_by = NICK;
  payload.updated_at = nowIso;
}

async function setWorkStatus(id, status){
  mustNick();

  const cur = items.find(x => x.id === id);
  if(cur?.update_done){
    alert("이미 '완료(업데이트)' 상태입니다.\n먼저 '완료(업데이트)'를 다시 눌러 완료를 해제한 뒤 상태를 변경해주세요.");
    return;
  }

  setSaving(true);
  const now = new Date().toISOString();
  const payload = { status };
  bumpLastChange(payload, now);
  const ok = await patchRow(id, payload);
  setSaving(false);
  if(ok) await load();
}


async function setOther(id){
  mustNick();
  const cur = items.find(x => x.id === id);
  const prevMemo = cur?.memo || "";
  const m = prompt("특이사항 메모 입력", prevMemo);
  if(m === null) return;

  setSaving(true);
  const now = new Date().toISOString();
  const payload = { status: "기타", memo: m.trim() };
  bumpLastChange(payload, now);
  const ok = await patchRow(id, payload);
  setSaving(false);
  if(ok) await load();
}

async function setRegion(id, region){
  mustNick();
  setSaving(true);
  const now = new Date().toISOString();
  const payload = { region };

  payload.region_confirmed = false;
  payload.region_by = null;
  payload.region_at = null;

  if(!regionNeedsMemo(region)) payload.region_memo = null;

  bumpLastChange(payload, now);
  const ok = await patchRow(id, payload);
  setSaving(false);
  if(ok) await load();
}

async function saveRegionMemo(id){
  mustNick();
  const input = document.getElementById(`regionMemo_${id}`);
  const memo = (input?.value || "").trim();
  if(!memo){
    alert("기타 지역 메모를 입력해주세요.");
    return;
  }
  setSaving(true);
  const now = new Date().toISOString();
  const payload = { region_memo: memo };
  bumpLastChange(payload, now);
  const ok = await patchRow(id, payload);
  setSaving(false);
  if(ok) await load();
}

async function toggleRegionConfirm(id){
  mustNick();
  const cur = items.find(x => x.id === id);
  const region = effRegion(cur);
  const regionMemo = cur?.region_memo || "";
  const curr = !!cur?.region_confirmed;
  const next = !curr;

  if(next){
    if(region === "확인 필요" || !region){
      alert("지역을 먼저 선택해주세요.");
      return;
    }
    if(regionNeedsMemo(region) && !regionMemo.trim()){
      alert("기타 지역 메모를 입력해주세요.");
      return;
    }
  }

  setSaving(true);
  const now = new Date().toISOString();
  const payload = {
    region_confirmed: next,
    region_by: next ? NICK : null,
    region_at: next ? now : null,
  };
  bumpLastChange(payload, now);
  const ok = await patchRow(id, payload);
  setSaving(false);
  if(ok) await load();
}

async function toggleUpdateDone(id){
  mustNick();
  const cur = items.find(x => x.id === id);
  const curr = !!cur?.update_done;
  const next = !curr;

  const region = effRegion(cur);
  const regionMemo = cur?.region_memo || "";

  // ✅ 완료 ON은 옵션A(지역 필수)
  if(next){
    if(!isRegionValidForComplete(region, regionMemo)){
      if(region === "확인 필요" || !region){
        alert("완료 처리 전에 지역을 선택해주세요.");
      } else if(regionNeedsMemo(region) && !regionMemo.trim()){
        alert("기타 지역은 메모 입력이 필요합니다.");
      } else {
        alert("완료 처리 전에 지역 정보를 확인해주세요.");
      }
      return;
    }
  } else {
    // ✅ 완료 OFF는 실수 방지 confirm
    const okConfirm = confirm("정말 '완료(업데이트)'를 해제할까요?");
    if(!okConfirm) return;
  }

  setSaving(true);
  const now = new Date().toISOString();
  const payload = {
    update_done: next,
    update_by: next ? NICK : null,
    update_at: next ? now : null,
  };
  bumpLastChange(payload, now);

  const ok = await patchRow(id, payload);
  setSaving(false);
  if(ok) await load();
}


/* 엑셀 다운로드(조치=카메라/DRV 포함) */
$("downloadBtn").onclick = ()=>{
  const rows = items.map(r => ({
    vin: r.vin,
    조치: gradeLabel(effGrade(r)),
    grade_raw: effGrade(r) || "",
    상태: derivedState(r),
    지역: effRegion(r),
    기타지역메모: r.region_memo || "",
    업데이트완료: r.update_done ? "Y" : "N",
    업데이트자: r.update_by || "",
    업데이트시간: formatKST(r.update_at),
    지역확정: r.region_confirmed ? "Y" : "N",
    지역확정자: r.region_by || "",
    지역확정시간: formatKST(r.region_at),
    메모: r.memo || "",
    최근변경자: r.updated_by || "",
    최근변경시간: formatKST(r.updated_at),
  }));

  const header = ["VIN","조치","grade(F/F+)","상태","지역","기타지역메모","업데이트완료(Y/N)","업데이트자","업데이트시간(KST)","지역확정(Y/N)","지역확정자","지역확정시간(KST)","메모","최근변경자","최근변경시간(KST)"];
  const aoa = [header, ...rows.map(x => [
    x.vin, x.조치, x.grade_raw, x.상태, x.지역, x.기타지역메모, x.업데이트완료, x.업데이트자, x.업데이트시간,
    x.지역확정, x.지역확정자, x.지역확정시간, x.메모, x.최근변경자, x.최근변경시간
  ])];

  const ws = XLSX.utils.aoa_to_sheet(aoa);
  ws["!cols"] = [
    { wch: 12 }, { wch: 8 }, { wch: 10 }, { wch: 8 }, { wch: 14 }, { wch: 22 },
    { wch: 16 }, { wch: 12 }, { wch: 22 }, { wch: 14 }, { wch: 12 }, { wch: 22 },
    { wch: 28 }, { wch: 12 }, { wch: 22 }
  ];

  const range = XLSX.utils.decode_range(ws["!ref"]);
  for(let C = range.s.c; C <= range.e.c; ++C){
    const addr = XLSX.utils.encode_cell({r:0, c:C});
    if(ws[addr]){
      ws[addr].s = {
        font: { bold: true, color: { rgb: "FFFFFF" } },
        fill: { fgColor: { rgb: "111111" } },
        alignment: { horizontal: "center", vertical: "center" }
      };
    }
  }

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Checklist");
  const stamp = new Date().toISOString().slice(0,19).replaceAll(":","-");
  XLSX.writeFile(wb, `sp3_hev_fca_${stamp}.xlsx`);
};

$("search").oninput = render;

function setActiveTabs(newTab){
  tab = newTab;
  document.querySelectorAll("#topTabs button").forEach(btn=>{
    btn.classList.toggle("active", btn.dataset.tab === newTab);
  });
  render();
}

/* 등급 필터 버튼 */
function setGradeFilter(g){
  gradeFilter = g;
  $("gAll").classList.toggle("active", g==="all");
  $("gF").classList.toggle("active", g==="F");
  $("gFp").classList.toggle("active", g==="F+");
  render();
}

$("gAll").onclick = ()=>setGradeFilter("all");
$("gF").onclick = ()=>setGradeFilter("F");
$("gFp").onclick = ()=>setGradeFilter("F+");

document.addEventListener("DOMContentLoaded", () => {
  $("verCam").innerText = VERSION.camera;
  $("verDrv").innerText = VERSION.drv;

  document.querySelectorAll('#topTabs button').forEach(btn => {
    btn.onclick = () => setActiveTabs(btn.dataset.tab);
  });

  mustNick();
  load();
  $("btnMine").onclick = renderMine;
  $("btnRecent").onclick = renderRecent;
});
</script>

<!-- 하단바는 일단 유지(원하면 내작업/최근변경 버전도 다시 붙여줄게) -->
<div class="bottomBar">
  <div class="bottomInner tabs" id="bottomTabs">
    <button id="btnMine">내 작업</button>
    <button id="btnRecent">최근 변경</button>
  </div>
</div>

</body>
</html>
