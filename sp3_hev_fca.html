<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SP3 HEV FCA 미동작 개선 실차 조치 List</title>
  <style>
    body{font-family:system-ui,-apple-system;margin:18px;line-height:1.35}
    .box{border:1px solid #ddd;border-radius:14px;padding:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,button,textarea,select{border:1px solid #ccc;border-radius:12px;padding:10px;font-size:14px}
    button{background:#f6f6f6}
    button:disabled{opacity:.55}
    .pill{border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-size:13px;background:#fff}
    .pillBtn{cursor:pointer}
    .pillBtn.active{background:#111;color:#fff;border-color:#111}
    .list{margin-top:14px;display:flex;flex-direction:column;gap:10px}
    .card{border:1px solid #e3e3e3;border-radius:16px;padding:12px}
    .vin{font-size:26px;font-weight:800}
    .muted{color:#666;font-size:13px}
    .tabs button{border-radius:999px;padding:8px 12px}
    .tabs button.active{background:#111;color:#fff;border-color:#111}
    .right{margin-left:auto}

    /* 하단 고정 탭 바 */
    #bottomTabs{display:flex;width:100%;gap:8px}
    #bottomTabs button{flex:1;text-align:center;white-space:nowrap}
    .bottomBar{
      position:fixed;left:0;right:0;bottom:0;
      background:#fff;border-top:1px solid #ddd;
      padding:10px 12px;z-index:9999;
    }
    .bottomInner{
      max-width:980px;margin:0 auto;
      display:flex;gap:8px;flex-wrap:wrap;
    }
    body{padding-bottom:86px;}

    .sectionTitle{margin-top:10px;margin-bottom:6px;font-weight:700}
    .warn{color:#b42318;font-weight:700}

    @media (max-width: 520px) {
      .summaryRow{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
      .summaryRow #search{width:100% !important;box-sizing:border-box}
      .summaryPct{width:100%}
      .growMobile{width:100%}
      select.growMobile{width:100%}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
</head>
<body>
  <h2>SP3 HEV FCA 미동작 개선 실차 조치 List</h2>

  <div class="box">
    <div class="row" style="justify-content:space-between">
      <div>사용자: <b id="nickLabel">(미설정)</b></div>
      <div class="row">
        <button id="nickBtn">닉네임 변경</button>
        <button id="downloadBtn">엑셀 다운로드(XLSX)</button>
      </div>
    </div>

    <!-- ✅ 버전 표기(여기만 수정하면 됨) -->
    <div class="row" style="margin-top:8px">
      <span class="pill">카메라: <b id="verCam">-</b></span>
      <span class="pill">DRV: <b id="verDrv">-</b></span>
    </div>

    <div class="row summaryRow" style="margin-top:10px">
      <input id="search" placeholder="VIN 검색(4자리)" inputmode="numeric" style="width:150px"/>

      <!-- ✅ F/F+ 필터 -->
      <span class="pill pillBtn active" id="gAll">등급 전체</span>
      <span class="pill pillBtn" id="gF">F</span>
      <span class="pill pillBtn" id="gFp">F+</span>

      <span class="pill" id="cntTotal">총 -</span>
      <span class="pill" id="cntDone">완료 -</span>
      <span class="pill" id="cntRemain">잔여 -</span>

      <div class="summaryPct" style="margin-top:10px;width:100%">
        <div class="muted">완료율: <b id="pctText">-</b></div>
        <div style="height:12px;border:1px solid #ddd;border-radius:999px;overflow:hidden;background:#eee">
          <div id="pctBar" style="height:100%;width:0%;background:linear-gradient(90deg,#4caf50,#2e7d32);transition:width .25s ease"></div>
        </div>
      </div>

      <span class="muted" id="saving"></span>
      <span class="right muted" id="rt"></span>
    </div>

    <!-- ✅ 상태 탭(상단은 이 5개만) -->
    <div class="row tabs" style="margin-top:10px" id="topTabs">
      <button data-tab="all" class="active">전체</button>
      <button data-tab="작업중">작업중</button>
      <button data-tab="완료">완료</button>
      <button data-tab="기타">기타</button>
      <button data-tab="remain">미완료</button>
    </div>

    <!-- ✅ 전체 탭에서만 지역별 요약 표시 -->
    <div id="regionSummaryWrap" style="display:none;margin-top:10px">
      <div class="sectionTitle">지역별 현황(탭 클릭 시 해당 지역만 보기)</div>
      <div class="row" id="regionSummary"></div>
      <div class="row" style="margin-top:6px">
        <span class="muted" id="regionFilterHint"></span>
      </div>
    </div>
  </div>

  <div class="list" id="list"></div>

<script>
/* ======= 설정(필수) ======= */
const SUPABASE_URL = "https://gpdtgrbiyrgekjtgxpgf.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdwZHRncmJpeXJnZWtqdGd4cGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1ODI3ODAsImV4cCI6MjA4NTE1ODc4MH0.tLZb3obtmHgWMTiKf4xhbsiOqmg80o2MPibQhB5Ywco";
const TABLE_NAME = "checklist_sp3_hev_fca"; // ✅ 너가 만든 신규 테이블
/* ============================ */

/* ✅ 버전(여기만 바꾸면 상단에 표시됨) */
const VERSION = { camera: "XXX", drv: "XXX" };

/* ✅ 지역 리스트(요청 순서 그대로) */
const REGION_LIST = [
  "광주 출고",
  "광주 공장",
  "광명 출고",
  "덕평 출고",
  "PBV 컨버전 출고",
  "화성 출고",
  "고덕 출고",
  "서산 출고",
  "충주 출고",
  "신태인 출고",
  "경산 출고",
  "기타",
  "확인 필요"
];

let NICK = localStorage.getItem("checklist_nick") || "";
let tab = "all";
let items = [];
let saving = false;

/* gradeFilter: 'all' | 'F' | 'F+' */
let gradeFilter = "all";
/* regionFilter: null | string */
let regionFilter = null;

const $ = (id)=>document.getElementById(id);

function mustNick(){
  while(!NICK){
    const n = prompt("닉네임을 입력하세요 (예: 신영/홍길동)");
    if(!n) continue;
    NICK = n.trim();
    localStorage.setItem("checklist_nick", NICK);
  }
  $("nickLabel").innerText = NICK;
}
$("nickBtn").onclick = ()=>{
  NICK = "";
  localStorage.removeItem("checklist_nick");
  mustNick();
};

function headers(preferReturn=true){
  const h = {
    "apikey": SUPABASE_ANON_KEY,
    "Authorization": "Bearer " + SUPABASE_ANON_KEY,
    "Content-Type": "application/json",
  };
  if(preferReturn) h["Prefer"] = "return=representation";
  return h;
}

function setSaving(v){
  saving=v;
  $("saving").innerText = v ? "저장중..." : "";
  document.querySelectorAll("button,select,input,textarea").forEach(el=>{
    if(el.id === "nickBtn") return;
    if(el.id === "search") return;
    el.disabled = v;
  });
  $("nickBtn").disabled = false;
}

function normStatus(s){
  s = (s || "").toString().trim();
  if (s === "" || s === "잔여" || s === "남음" || s === "remain" || s === "미완" || s === "미완료") return "미완료";
  if (s === "작업중") return "작업중";
  if (s === "기타") return "기타";
  if (s === "완료") return "완료"; // 혹시 레거시가 있으면 유지
  return "미완료";
}

function formatKST(iso){
  if(!iso) return "-";
  const d = new Date(iso);
  return new Intl.DateTimeFormat("ko-KR", {
    timeZone: "Asia/Seoul",
    year: "numeric", month: "2-digit", day: "2-digit",
    hour: "2-digit", minute: "2-digit", second: "2-digit",
    hour12: false
  }).format(d);
}

function effGrade(it){
  const g = (it.grade || "").toString().trim();
  if(g === "F" || g === "F+") return g;
  return ""; // 미기재
}

function effRegion(it){
  const r = (it.region || "").toString().trim();
  if(!r) return "확인 필요";
  return r;
}

function effUpdateDone(it){
  return !!it.update_done;
}

function derivedState(it){
  // ✅ 완료는 update_done 기준
  if(effUpdateDone(it)) return "완료";
  // 그 외는 status 기준(미완료/작업중/기타)
  return normStatus(it.status);
}

function regionNeedsMemo(region){
  return region === "기타";
}

function isRegionValidForComplete(region, regionMemo){
  if(!region || region === "확인 필요") return false;
  if(regionNeedsMemo(region) && !(regionMemo || "").trim()) return false;
  return true;
}

async function load(){
  const url = `${SUPABASE_URL}/rest/v1/${TABLE_NAME}?select=*`;
  const r = await fetch(url, {headers: headers(true)});
  if(!r.ok){
    $("rt").innerText = "로드 실패";
    console.log(await r.text());
    return;
  }
  items = await r.json();
  $("rt").innerText = "연결됨 ✅";
  render();
}

function applyGradeFilter(view){
  if(gradeFilter === "all") return view;
  return view.filter(x => effGrade(x) === gradeFilter);
}

function applyRegionFilter(view){
  if(!regionFilter) return view;
  return view.filter(x => effRegion(x) === regionFilter);
}

function renderRegionSummary(baseView){
  // 전체 탭 + 전체 지역 보기일 때만 보여주자 (지역필터는 있어도 표시)
  $("regionSummaryWrap").style.display = (tab === "all") ? "block" : "none";
  if(tab !== "all") return;

  const wrap = $("regionSummary");
  wrap.innerHTML = "";

  const filtered = applyGradeFilter(baseView); // 등급 필터만 반영해서 지역요약을 봄
  const counts = {};
  REGION_LIST.forEach(r => counts[r] = {total:0, done:0});

  filtered.forEach(it=>{
    const r = effRegion(it);
    if(!counts[r]) counts[r] = {total:0, done:0};
    counts[r].total += 1;
    if(effUpdateDone(it)) counts[r].done += 1;
  });

  REGION_LIST.forEach(r=>{
    const c = counts[r] || {total:0, done:0};
    if(c.total === 0 && r !== "확인 필요") return; // 표시 과다 방지(확인 필요는 항상 보여주고 싶으면 조건 제거)
    const pill = document.createElement("span");
    pill.className = "pill pillBtn" + (regionFilter === r ? " active" : "");
    const remain = c.total - c.done;
    pill.textContent = `${r}  ${c.done}/${c.total} (잔여 ${remain})`;
    pill.onclick = ()=>{
      regionFilter = (regionFilter === r) ? null : r;
      render();
    };
    wrap.appendChild(pill);
  });

  const hint = $("regionFilterHint");
  if(regionFilter){
    hint.innerHTML = `현재 지역 필터: <b>${regionFilter}</b> (다시 누르면 해제)`;
  } else {
    hint.innerText = "지역별 요약을 눌러 해당 지역만 필터링할 수 있어요.";
  }
}

function render(){
  const q = $("search").value.trim();

  // base normalize
  let view = items.map(x=>({
    ...x,
    _status: normStatus(x.status),
    _state: derivedState(x),
    _grade: effGrade(x),
    _region: effRegion(x),
    _done: effUpdateDone(x),
  }));

  // 탭 필터(상태)
  if(tab !== "all"){
    if(tab === "remain"){
      view = view.filter(x => x._state === "미완료");
    } else {
      view = view.filter(x => x._state === tab);
    }
  }

  // 등급/지역 필터
  view = applyGradeFilter(view);
  view = applyRegionFilter(view);

  // 검색
  if(q) view = view.filter(x=>String(x.vin).includes(q));

  // 정렬: 미완료/작업중/기타/완료 느낌으로 VIN 정렬
  const order = {"미완료":1,"작업중":2,"기타":3,"완료":4};
  view.sort((a,b)=>
    (order[a._state]||9)-(order[b._state]||9) ||
    String(a.vin).localeCompare(String(b.vin))
  );

  // ✅ 카운트/완료율은 "등급/지역 필터 반영된 전체" 기준으로 보는 게 직관적
  const baseForCount = applyRegionFilter(applyGradeFilter(items));
  const total = baseForCount.length;
  const done = baseForCount.filter(x=>effUpdateDone(x)).length;

  $("cntTotal").innerText = `총 ${total}`;
  $("cntDone").innerText = `완료 ${done}`;
  $("cntRemain").innerText = `잔여 ${Math.max(0, total - done)}`;

  const pct = total ? Math.round((done / total) * 100) : 0;
  $("pctText").innerText = pct + "%";
  $("pctBar").style.width = pct + "%";

  // 지역 요약(전체 탭일 때만)
  renderRegionSummary(items);

  // 리스트 렌더
  const box = $("list");
  box.innerHTML="";

  view.forEach(it=>{
    const d = document.createElement("div");
    d.className="card";

    const lastBy = it.updated_by || "-";
    const lastAt = it.updated_at || null;

    const updDone = !!it.update_done;
    const updMark = updDone ? "✅" : "⬜";
    const updBy = it.update_by || "-";
    const updAt = it.update_at || null;

    const reg = effRegion(it);
    const regMemo = it.region_memo || "";
    const regConfirmed = !!it.region_confirmed;
    const regMark = regConfirmed ? "✅" : "⬜";
    const regBy = it.region_by || "-";
    const regAt = it.region_at || null;

    const state = it._state;
    const grade = it._grade || "-";

    const memoText = it.memo ? it.memo : "-";

    const needsRegion = updDone && !isRegionValidForComplete(reg, regMemo);
    const warnHtml = needsRegion ? `<div class="muted warn">⚠ 지역이 미입력/미확정 상태입니다.</div>` : "";

    d.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <div class="vin">${it.vin}</div>
          <div class="muted">등급: <b>${grade}</b></div>
          <div class="muted">상태: <b>${state}</b></div>
        </div>
        <div class="right muted">연결됨 ✅</div>
      </div>

      ${warnHtml}

      <div class="muted">업데이트: ${updMark} ${formatKST(updAt)} · ${updBy}</div>
      <div class="muted">지역확정: ${regMark} ${formatKST(regAt)} · ${regBy}</div>
      <div class="muted">최근변경: ${formatKST(lastAt)} · ${lastBy}</div>

      <div class="row" style="margin-top:10px;align-items:center">
        <div class="muted" style="min-width:56px">지역</div>
        <select class="growMobile" onchange="setRegion('${it.id}', this.value)">
          ${REGION_LIST.map(r=>`<option value="${r}" ${r===reg?"selected":""}>${r}</option>`).join("")}
        </select>
        <button onclick="toggleRegionConfirm('${it.id}')">지역확정</button>
      </div>

      <div class="row" style="margin-top:8px;align-items:center;${regNeedsMemo(reg) ? "" : "display:none"}" id="regionMemoRow_${it.id}">
        <div class="muted" style="min-width:56px">기타메모</div>
        <input class="growMobile" id="regionMemo_${it.id}" placeholder="기타 지역 메모" value="${escapeHtml(regMemo)}" />
        <button onclick="saveRegionMemo('${it.id}')">저장</button>
      </div>

      <div class="muted" style="margin-top:8px">메모: ${escapeHtml(memoText)}</div>

      <div class="row" style="margin-top:10px">
        <button onclick="setWorkStatus('${it.id}','미완료')">미완료</button>
        <button onclick="setWorkStatus('${it.id}','작업중')">작업중</button>
        <button onclick="toggleUpdateDone('${it.id}')">완료(업데이트)</button>
        <button onclick="setOther('${it.id}')">기타</button>
      </div>
    `;

    box.appendChild(d);
  });
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

async function patchRow(id, payload){
  const url = `${SUPABASE_URL}/rest/v1/${TABLE_NAME}?id=eq.${encodeURIComponent(id)}`;
  const r = await fetch(url, {method:"PATCH", headers: headers(true), body: JSON.stringify(payload)});
  if(!r.ok){
    alert("저장 실패. 콘솔/권한/RLS 확인 필요");
    console.log(await r.text());
    return false;
  }
  return true;
}

function bumpLastChange(payload, nowIso){
  payload.updated_by = NICK;
  payload.updated_at = nowIso;
}

async function setWorkStatus(id, status){
  mustNick();
  setSaving(true);

  const now = new Date().toISOString();
  const payload = { status };
  bumpLastChange(payload, now);

  const ok = await patchRow(id, payload);
  setSaving(false);
  if(ok) await load();
}

async function setOther(id){
  mustNick();
  const cur = items.find(x => x.id === id);
  const prevMemo = cur?.memo || "";
  const m = prompt("특이사항 메모 입력", prevMemo);
  if(m === null) return;

  setSaving(true);
  const now = new Date().toISOString();
  const payload = {
    status: "기타",
    memo: m.trim(),
  };
  bumpLastChange(payload, now);

  const ok = await patchRow(id, payload);
  setSaving(false);
  if(ok) await load();
}

async function setRegion(id, region){
  mustNick();
  setSaving(true);

  const now = new Date().toISOString();
  const payload = {
    region,
  };

  // 지역 바꾸면 확정은 기본적으로 풀어주는 게 안전(원하면 유지로 바꿔줄 수도 있음)
  payload.region_confirmed = false;
  payload.region_by = null;
  payload.region_at = null;

  // 기타가 아니면 region_memo 비움
  if(!regionNeedsMemo(region)){
    payload.region_memo = null;
  }

  bumpLastChange(payload, now);

  const ok = await patchRow(id, payload);
  setSaving(false);
  if(ok) await load();
}

async function saveRegionMemo(id){
  mustNick();
  const input = document.getElementById(`regionMemo_${id}`);
  const memo = (input?.value || "").trim();

  // 기타일 때는 메모 필수로 운영할 거면 여기서도 막아줌
  if(!memo){
    alert("기타 지역 메모를 입력해주세요.");
    return;
  }

  setSaving(true);
  const now = new Date().toISOString();
  const payload = { region_memo: memo };
  bumpLastChange(payload, now);

  const ok = await patchRow(id, payload);
  setSaving(false);
  if(ok) await load();
}

async function toggleRegionConfirm(id){
  mustNick();
  const cur = items.find(x => x.id === id);
  const region = effRegion(cur);
  const regionMemo = cur?.region_memo || "";
  const curr = !!cur?.region_confirmed;
  const next = !curr;

  // 확정 ON 할 때만 유효성 체크
  if(next){
    if(region === "확인 필요" || !region){
      alert("지역을 먼저 선택해주세요.");
      return;
    }
    if(regionNeedsMemo(region) && !regionMemo.trim()){
      alert("기타 지역 메모를 입력해주세요.");
      return;
    }
  }

  setSaving(true);
  const now = new Date().toISOString();
  const payload = {
    region_confirmed: next,
    region_by: next ? NICK : null,
    region_at: next ? now : null,
  };
  bumpLastChange(payload, now);

  const ok = await patchRow(id, payload);
  setSaving(false);
  if(ok) await load();
}

async function toggleUpdateDone(id){
  mustNick();
  const cur = items.find(x => x.id === id);
  const curr = !!cur?.update_done;
  const next = !curr;

  const region = effRegion(cur);
  const regionMemo = cur?.region_memo || "";

  // ✅ 옵션 A: 완료(ON)하려면 지역 필수(확인 필요 불가), 기타면 메모 필수
  if(next){
    if(!isRegionValidForComplete(region, regionMemo)){
      if(region === "확인 필요" || !region){
        alert("완료 처리 전에 지역을 선택해주세요.");
      } else if(regionNeedsMemo(region) && !regionMemo.trim()){
        alert("기타 지역은 메모 입력이 필요합니다.");
      } else {
        alert("완료 처리 전에 지역 정보를 확인해주세요.");
      }
      return;
    }
  }

  setSaving(true);
  const now = new Date().toISOString();
  const payload = {
    update_done: next,
    update_by: next ? NICK : null,
    update_at: next ? now : null,
  };

  // 완료 ON이면 상태를 '완료'로 저장하지 않고, derivedState로만 완료 표시(혼선 방지)
  // 대신, 완료 OFF면 status는 유지.

  bumpLastChange(payload, now);

  const ok = await patchRow(id, payload);
  setSaving(false);
  if(ok) await load();
}

/* ✅ 엑셀 다운로드(grade/region/update/지역확정/최근변경 포함) */
$("downloadBtn").onclick = ()=>{
  const rows = items.map(r => ({
    vin: r.vin,
    grade: effGrade(r) || "",
    상태: derivedState(r),
    지역: effRegion(r),
    기타지역메모: r.region_memo || "",
    업데이트완료: r.update_done ? "Y" : "N",
    업데이트자: r.update_by || "",
    업데이트시간: formatKST(r.update_at),
    지역확정: r.region_confirmed ? "Y" : "N",
    지역확정자: r.region_by || "",
    지역확정시간: formatKST(r.region_at),
    메모: r.memo || "",
    최근변경자: r.updated_by || "",
    최근변경시간: formatKST(r.updated_at),
  }));

  const header = ["VIN","등급","상태","지역","기타지역메모","업데이트완료(Y/N)","업데이트자","업데이트시간(KST)","지역확정(Y/N)","지역확정자","지역확정시간(KST)","메모","최근변경자","최근변경시간(KST)"];
  const aoa = [header, ...rows.map(x => [
    x.vin, x.grade, x.상태, x.지역, x.기타지역메모, x.업데이트완료, x.업데이트자, x.업데이트시간,
    x.지역확정, x.지역확정자, x.지역확정시간, x.메모, x.최근변경자, x.최근변경시간
  ])];

  const ws = XLSX.utils.aoa_to_sheet(aoa);

  ws["!cols"] = [
    { wch: 12 }, { wch: 6 }, { wch: 8 }, { wch: 14 }, { wch: 22 },
    { wch: 16 }, { wch: 12 }, { wch: 22 },
    { wch: 14 }, { wch: 12 }, { wch: 22 },
    { wch: 28 }, { wch: 12 }, { wch: 22 }
  ];

  const range = XLSX.utils.decode_range(ws["!ref"]);

  // 헤더 스타일
  for(let C = range.s.c; C <= range.e.c; ++C){
    const addr = XLSX.utils.encode_cell({r:0, c:C});
    if(ws[addr]){
      ws[addr].s = {
        font: { bold: true, color: { rgb: "FFFFFF" } },
        fill: { fgColor: { rgb: "111111" } },
        alignment: { horizontal: "center", vertical: "center" }
      };
    }
  }

  // 상태별 행 배경색
  const colorByStatus = {
    "완료": "C6EFCE",
    "작업중": "D9E1F2",
    "기타": "FFF2CC",
    "미완료": "F2F2F2"
  };

  for(let R = 1; R <= range.e.r; ++R){
    const stateAddr = XLSX.utils.encode_cell({r:R, c:2}); // 상태 col (C)
    const statusVal = ws[stateAddr]?.v;
    const fillColor = colorByStatus[statusVal];
    if(fillColor){
      for(let C = range.s.c; C <= range.e.c; ++C){
        const addr = XLSX.utils.encode_cell({r:R, c:C});
        if(ws[addr]){
          ws[addr].s = ws[addr].s || {};
          ws[addr].s.fill = { fgColor: { rgb: fillColor } };
        }
      }
    }
  }

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Checklist");

  const stamp = new Date().toISOString().slice(0,19).replaceAll(":","-");
  XLSX.writeFile(wb, `sp3_hev_fca_${stamp}.xlsx`);
};

$("search").oninput = render;

/* 탭 */
function setActiveTabs(newTab){
  tab = newTab;
  document.querySelectorAll("#topTabs button, #bottomTabs button").forEach(btn=>{
    btn.classList.toggle("active", btn.dataset.tab === newTab);
  });
  render();
}

/* 내 작업 / 최근 변경 */
function showMine(){
  mustNick();
  tab = "mine";
  renderMine();
}
function showRecent(){
  tab = "recent";
  renderRecent();
}

function renderMine(){
  // 기준: 내가 마지막 변경자이거나, 내가 업데이트 완료자로 남은 것
  let view = items.filter(x => (x.updated_by||"") === NICK || (x.update_by||"") === NICK);

  view = applyGradeFilter(view);
  view = applyRegionFilter(view);

  // 최근변경 최신순
  view.sort((a,b)=> new Date(b.updated_at||0).getTime() - new Date(a.updated_at||0).getTime());

  renderSimpleList(view, "내 작업");
}

function renderRecent(){
  const since = Date.now() - 30*60*1000; // 30분
  let view = items.filter(x => x.updated_at && (new Date(x.updated_at).getTime() >= since));

  view = applyGradeFilter(view);
  view = applyRegionFilter(view);

  view.sort((a,b)=> new Date(b.updated_at||0).getTime() - new Date(a.updated_at||0).getTime());

  renderSimpleList(view, "최근 변경(30분)");
}

function renderSimpleList(view, title){
  const box = $("list");
  box.innerHTML = "";
  const head = document.createElement("div");
  head.className = "muted";
  head.style.marginTop = "10px";
  head.innerHTML = `<b>${title}</b> · ${view.length}건`;
  box.appendChild(head);

  // 상태탭 active 해제(내작업/최근변경은 별도 모드)
  document.querySelectorAll("#topTabs button").forEach(btn=>btn.classList.remove("active"));

  view.forEach(it=>{
    const d = document.createElement("div");
    d.className="card";
    const updMark = it.update_done ? "✅" : "⬜";
    const regMark = it.region_confirmed ? "✅" : "⬜";

    d.innerHTML = `
      <div class="vin">${it.vin}</div>
      <div class="muted">등급: <b>${effGrade(it)||"-"}</b> · 상태: <b>${derivedState(it)}</b></div>
      <div class="muted">업데이트: ${updMark} ${formatKST(it.update_at)} · ${it.update_by || "-"}</div>
      <div class="muted">지역확정: ${regMark} ${formatKST(it.region_at)} · ${it.region_by || "-"}</div>
      <div class="muted">지역: <b>${effRegion(it)}</b> ${effRegion(it)==="기타" ? `(${escapeHtml(it.region_memo||"")})` : ""}</div>
      <div class="muted">최근변경: ${formatKST(it.updated_at)} · ${it.updated_by || "-"}</div>
    `;
    box.appendChild(d);
  });
}

/* 등급 필터 버튼 */
function setGradeFilter(g){
  gradeFilter = g;
  $("gAll").classList.toggle("active", g==="all");
  $("gF").classList.toggle("active", g==="F");
  $("gFp").classList.toggle("active", g==="F+");

  // 내작업/최근 모드일 수도 있으니 현재 모드대로 렌더
  if(tab === "mine") return renderMine();
  if(tab === "recent") return renderRecent();
  render();
}

$("gAll").onclick = ()=>setGradeFilter("all");
$("gF").onclick = ()=>setGradeFilter("F");
$("gFp").onclick = ()=>setGradeFilter("F+");

/* 초기화 */
document.addEventListener("DOMContentLoaded", () => {
  $("verCam").innerText = VERSION.camera;
  $("verDrv").innerText = VERSION.drv;

  document.querySelectorAll('#topTabs button').forEach(btn => {
    btn.onclick = () => setActiveTabs(btn.dataset.tab);
  });

  mustNick();
  load();
});
</script>

<!-- ✅ 하단바: 내 작업 / 최근 변경만 -->
<div class="bottomBar">
  <div class="bottomInner tabs" id="bottomTabs">
    <button data-tab="mine" onclick="showMine()">내 작업</button>
    <button data-tab="recent" onclick="showRecent()">최근 변경</button>
  </div>
</div>

</body>
</html>
